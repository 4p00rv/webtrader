define(["exports","jquery","websockets/binary_websockets","windows/windows","common/rivetsExtra","cashier/currency","lodash","moment"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){return a&&a.__esModule?a:{"default":a}}function j(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(a,"__esModule",{value:!0});{var k=i(b),l=i(c),m=i(d),n=i(e),o=i(f);i(h)}require(["text!cashier/withdraw.html"]),require(["css!cashier/withdraw.css"]);var p=null,q=null,r=function(a){k["default"].growl.error({message:a.message})},s=function t(){var a=this;j(this,t),this.init=function(b){b.click(function(){p?p.moveToTop():l["default"].cached.authorize().then(function(a){return a.authorize.currency?!0:o["default"].check_currency()}).then(function(){return require(["text!cashier/withdraw.html"],a._init_win)})["catch"](r)})},this._init_win=function(b){b=k["default"](b).i18n(),p=m["default"].createBlankWindow(b,{title:"Withdraw funds",resizable:!0,collapsable:!1,minimizable:!0,maximizable:!0,width:700,height:400,"data-authorized":!0,close:function(){p.dialog("destroy"),p.trigger("dialogclose"),p.remove(),p=null},open:function(){},destroy:function(){q&&q.unbind(),q=null}}),a._init_state(b),p.dialog("open");var c=p.dialog("widget").offset();c.top=110,p.dialog("option","position",{my:c.left,at:c.top}),p.dialog("widget").css({left:c.left+"px",top:c.top+"px"}),p.fixFooterPosition(),p.track({module_id:"withdraw",is_unique:!0})},this._init_state=function(a){var b={route:{value:"menu"},empty_fields:{validate:!1,token_length:!1,clear:g.debounce(function(){b.empty_fields.validate=!1,b.empty_fields.token_length=!1},4e3),show:function(){b.empty_fields.validate=!0,b.empty_fields.clear()},validateLength:function(){return 48!=b.verify.token.length?(b.empty_fields.token_length=!0,b.empty_fields.clear(),!1):!0}},menu:{choice:""},verify:{token:"",code:"",disabled:!1},transfer:{disabled:!1,account:"",amount:"",loginid:local_storage.get("authorize").loginid},standard:{url:"",iframe_visible:!1},agent:{disabled:!1,loginid:"",name:"",agents:[],commission:"",amount:"",currency:local_storage.get("authorize").currency,residence:"",instructions:"",checkAmount:function(a,b){var c=b.agent.amount;""!=c&&(c>2e3&&(b.agent.amount=2e3),0>c&&(b.agent.amount=""))}},login_details:Cookies.loginids().reduce(function(a,b){return a.id==local_storage.get("authorize").loginid?a:b})},c=b.route,d=b.menu,e=b.verify,f=b.empty_fields,h=b.standard,i=b.agent,j=b.transfer,m={menu:400,verify:400,transfer:400,"transfer-done":300,standard:400,agent:550,"agent-confirm":400,"agent-done":300};c.update=function(a){c.value=a,p.dialog("option","height",m[a])},d.click=function(a){if(d.choice=a,c.update("transfer"!==a?"verify":"transfer"),"transfer"!==a){var b=local_storage.get("authorize").email,e="agent"===a?"paymentagent_withdraw":"payment_withdraw";l["default"].send({verify_email:b,type:e}).then(function(){return k["default"].growl.notice({message:"Verification code sent to ".i18n()+b})})["catch"](function(a){r(a),c.update("menu")})}},e.back=function(){e.token=e.code="",c.update("menu")},e.unlock=function(){return e.token?void(f.validateLength()&&("standard"===d.choice?(e.disabled=!0,l["default"].send({cashier:"withdraw",verification_code:e.token}).then(function(a){if(a.cashier.startsWith("ASK_"))throw new Error(a.cashier);h.url=a.cashier,e.disabled=!1,c.update("standard"),e.code=e.token,e.token=""})["catch"](function(a){e.disabled=!1,r(a)})):"agent"==d.choice&&(e.code=e.token,e.token="",c.update("agent")))):void f.show()},h.iframe_loaded=function(){h.url&&(h.iframe_visible=!0)},i.onchanged=function(){if(i.loginid){var a=i.agents.find(function(a){return a.paymentagent_loginid==i.loginid}),b=a.withdrawal_commission,c=a.name;i.commission=b,i.name=c}else i.commission="",i.name=""},i.amount_with_commission=function(){var a=(i.amount||0)*(100-i.commission)/100;return a.toFixed(2)},i.click=function(){return i.loginid?i.amount>=10&&i.amount<=2e3?i.instructions?void c.update("agent-confirm"):void f.show():void k["default"].growl.error({message:"Amount Min: 10 Max: 2000".i18n()}):void k["default"].growl.error({message:"Please select a payment agent".i18n()})},i.confirm_transfer=function(){var a={paymentagent_withdraw:1,paymentagent_loginid:i.loginid,currency:i.currency,amount:1*i.amount,verification_code:e.code};i.disabled=!0,l["default"].send(a).then(function(){c.update("agent-done"),i.disabled=!1})["catch"](function(a){i.disabled=!1,c.update("menu"),r(a)})},j.submit=function(){if(""===j.account||""===j.amount)return void f.show();var a={transfer_between_accounts:1,account_from:j.loginid,account_to:j.account,currency:i.currency,amount:j.amount};j.disabled=!0,l["default"].send(a).then(function(a){return 0===a.transfer_between_accounts?void k["default"].growl.error({message:"Transfering funds between accounts failed".i18n()}):void c.update("transfer-done")})["catch"](function(a){r(a),j.disabled=!1})},l["default"].send({get_settings:1}).then(function(a){return i.residence=a.get_settings.country_code,l["default"].cached.send({paymentagent_list:i.residence})}).then(function(a){i.agents=a.paymentagent_list.list})["catch"](r),l["default"].send({payout_currencies:1}).then(function(a){i.currency=a.payout_currencies[0]})["catch"](function(a){return void 0}),q=n["default"].bind(a[0],b)}};a["default"]=new s});