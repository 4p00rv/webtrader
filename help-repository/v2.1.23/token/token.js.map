{"version":3,"sources":["../../../../src/token/token.es6"],"names":["token_win","token_win_view","binders","routine","el","text","clip","trigger","on","$","growl","notice","message","error","i18n","_rv_clipboard_","destroy","unbind","init_state","root","state","route","search_input","tokens","token","name","scopes","read","trade","payments","admin","btn_disabled","checkTokenName","e","scope","token_name","length","substr","match","replace","confirm","visible","top","tokens_filtered","txt","toLowerCase","filter","display_name","indexOf","permissions","show","span","target","position","parent","height","attr","no","yes","send","api_token","delete_token","then","data","update_tokens","catch","err","change_route","forEach","join","last_used_tooltip","last_used","utc","fromNow","add","request","new_token","new_token_scopes","push","error_msg","console","bind","initTokenWin","createBlankWindow","title","resizable","collapsable","minimizable","maximizable","width","minHeight","close","track","module_id","is_unique","dialog","init","$menuLink","click","moveToTop"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAUA,QAAIA,YAAY,IAAhB;AACA,QAAIC,iBAAiB,IAArB;;AAEA;AACA,0BAAGC,OAAH,CAAW,WAAX,IAA0B;AACtBC,iBAAS,iBAACC,EAAD,EAAKC,KAAL,EAAc;AACnB,gBAAMC,OAAO,wBAAcF,EAAd,EAAkB;AAC3BC,sBAAM,cAACE,OAAD,EAAa;AACf,2BAAOF,KAAP;AACH;AAH0B,aAAlB,CAAb;;AAMAC,iBAAKE,EAAL,CAAQ,SAAR,EAAmB,YAAM;AACrBC,kBAAEC,KAAF,CAAQC,MAAR,CAAe,EAAEC,SAAS,aAAaP,KAAb,GAAoB,GAA/B,EAAf;AACH,aAFD;;AAIAC,iBAAKE,EAAL,CAAQ,OAAR,EAAiB,YAAM;AACnBC,kBAAEC,KAAF,CAAQG,KAAR,CAAc,EAAED,SAAS,kDAAkDE,IAAlD,EAAX,EAAd;AACH,aAFD;;AAIAV,eAAGW,cAAH,IAAqBX,GAAGW,cAAH,CAAkBC,OAAlB,EAArB;AACAZ,eAAGW,cAAH,GAAoBT,IAApB;AACH,SAlBqB;AAmBtBW,gBAAQ,gBAACb,EAAD,EAAQ;AACZA,eAAGW,cAAH,CAAkBC,OAAlB;AACH;AArBqB,KAA1B;;AAwBA,QAAME,aAAa,SAAbA,UAAa,CAACC,IAAD,EAAU;AACzB,YAAMC,QAAQ;AACVC,mBAAO,YADG;AAEVC,0BAAc,EAFJ;AAGVC,oBAAQ,EAHE;AAIVC,mBAAO;AACHC,sBAAM,EADH;AAEHC,wBAAQ;AACJC,0BAAM,IADF;AAEJC,2BAAO,KAFH;AAGJC,8BAAU,KAHN;AAIJC,2BAAO;AAJH,iBAFL;AAQHC,8BAAc,KARX;AASHC,gCAAgB,wBAACC,CAAD,EAAGC,KAAH,EAAa;AAC3B,wBAAIC,aAAaD,MAAMV,KAAN,CAAYC,IAA7B;AACA,wBAAGU,WAAWC,MAAX,GAAoB,EAAvB,EAA0B;AACxB3B,0BAAEC,KAAF,CAAQG,KAAR,CAAc,EAACD,SAAQ,iDAAiDE,IAAjD,EAAT,EAAd;AACAoB,8BAAMV,KAAN,CAAYC,IAAZ,GAAmBU,WAAWE,MAAX,CAAkB,CAAlB,EAAoB,EAApB,CAAnB;AACD;AACD,wBAAGF,WAAWG,KAAX,CAAiB,WAAjB,KAAiC,IAApC,EAAyC;AACvC7B,0BAAEC,KAAF,CAAQG,KAAR,CAAc,EAACD,SAAQ,6EAA6EE,IAA7E,EAAT,EAAd;AACAoB,8BAAMV,KAAN,CAAYC,IAAZ,GAAmBU,WAAWI,OAAX,CAAmB,WAAnB,EAAgC,EAAhC,CAAnB;AACD;AACF;AAnBE,aAJG;AAyBVC,qBAAS;AACLC,yBAAS,KADJ;AAELC,qBAAK,KAFA;AAGLlB,uBAAO;AAHF;AAzBC,SAAd;;AAgCAJ,cAAMuB,eAAN,GAAwB,YAAM;AAC1B,gBAAMC,MAAMxB,MAAME,YAAN,CAAmBuB,WAAnB,EAAZ;AACA,mBAAOzB,MAAMG,MAAN,CAAauB,MAAb,CAAoB,UAACtB,KAAD,EAAW;AAClC,uBAAOoB,QAAQ,EAAR,IAAcpB,MAAMuB,YAAN,CAAmBF,WAAnB,GAAiCG,OAAjC,CAAyCJ,GAAzC,MAAkD,CAAC,CAAjE,IAAsEpB,MAAMA,KAAN,CAAYqB,WAAZ,GAA0BG,OAA1B,CAAkCJ,GAAlC,MAA2C,CAAC,CAAlH,IAAuHpB,MAAMyB,WAAN,CAAkBJ,WAAlB,GAAgCG,OAAhC,CAAwCJ,GAAxC,MAAiD,CAAC,CAAhL;AACH,aAFM,CAAP;AAGH,SALD;;AAOAxB,cAAMoB,OAAN,CAAcU,IAAd,GAAqB,UAACjB,CAAD,EAAO;AACxB,gBAAMkB,OAAO1C,EAAEwB,EAAEmB,MAAJ,CAAb;AACA,gBAAMV,MAAMS,KAAKE,QAAL,GAAgBX,GAAhB,GAAsBS,KAAKG,MAAL,GAAcA,MAAd,GAAuBC,MAAvB,EAAlC;AACA,gBAAI/B,QAAQ2B,KAAKK,IAAL,CAAU,UAAV,CAAZ;AACAhC,oBAAQ,kBAAKJ,MAAMG,MAAX,EAAmB,EAAEC,OAAOA,KAAT,EAAnB,CAAR;AACAJ,kBAAMoB,OAAN,CAAcE,GAAd,GAAoBA,MAAM,IAA1B;AACAtB,kBAAMoB,OAAN,CAAcC,OAAd,GAAwB,IAAxB;AACArB,kBAAMoB,OAAN,CAAchB,KAAd,GAAsBA,KAAtB;AAEH,SATD;AAUAJ,cAAMoB,OAAN,CAAciB,EAAd,GAAmB,YAAM;AACrBrC,kBAAMoB,OAAN,CAAcC,OAAd,GAAwB,KAAxB;AACH,SAFD;AAGArB,cAAMoB,OAAN,CAAckB,GAAd,GAAoB,YAAM;AACtB,gBAAMlC,QAAQJ,MAAMoB,OAAN,CAAchB,KAA5B;AACAJ,kBAAMoB,OAAN,CAAcC,OAAd,GAAwB,KAAxB;AACA,wCAAQkB,IAAR,CAAa,EAAEC,WAAW,CAAb,EAAgBC,cAAcrC,MAAMA,KAApC,EAAb,EACKsC,IADL,CACU,UAACC,IAAD,EAAU;AACZ,oBAAMxC,SAAUwC,KAAKH,SAAL,IAAkBG,KAAKH,SAAL,CAAerC,MAAlC,IAA6C,EAA5D;AACAH,sBAAM4C,aAAN,CAAoBzC,MAApB;AACH,aAJL,EAKK0C,KALL,CAKW,UAACC,GAAD,EAAS;AACZzD,kBAAEC,KAAF,CAAQG,KAAR,CAAc,EAAED,SAASsD,IAAItD,OAAf,EAAd;AACH,aAPL;AAQH,SAXD;;AAaAQ,cAAM+C,YAAN,GAAqB,UAAC9C,KAAD,EAAW;AAC5B,gBAAIA,UAAU,YAAd,EACID,MAAMoB,OAAN,CAAcC,OAAd,GAAwB,KAAxB;AACJrB,kBAAMC,KAAN,GAAcA,KAAd;AACH,SAJD;AAKAD,cAAM4C,aAAN,GAAsB,UAACzC,MAAD,EAAY;AAC9BA,mBAAO6C,OAAP,CAAe,UAAC5C,KAAD,EAAW;AACtB,oBAAME,SAASF,MAAME,MAArB;AACAF,sBAAMyB,WAAN,GAAoBvB,OAAOU,MAAP,IAAiB,CAAjB,GAAqB,KAArB,GAA6BV,OAAO2C,IAAP,CAAY,IAAZ,CAAjD;;AAEA7C,sBAAM8C,iBAAN,GAA0B9C,MAAM+C,SAAhC;AACA/C,sBAAM+C,SAAN,GAAkB/C,MAAM+C,SAAN,GAAkB,iBAAOC,GAAP,CAAWhD,MAAM+C,SAAjB,EAA4B,qBAA5B,EAAmDE,OAAnD,EAAlB,GAAiF,GAAnG;AACH,aAND;AAOArD,kBAAMG,MAAN,GAAeA,MAAf;AACH,SATD;;AAWAH,cAAMI,KAAN,CAAYkD,GAAZ,GAAkB,YAAM;AACpB,gBAAGtD,MAAMI,KAAN,CAAYC,IAAZ,CAAiBW,MAAjB,GAA0B,CAA7B,EAA+B;AAC7B3B,kBAAEC,KAAF,CAAQG,KAAR,CAAc,EAACD,SAAQ,+CAA+CE,IAA/C,EAAT,EAAd;AACA;AACD;;AAED,gBAAM6D,UAAU;AACZf,2BAAW,CADC;AAEZgB,2BAAWxD,MAAMI,KAAN,CAAYC,IAFX;AAGZoD,kCAAkB;AAHN,aAAhB;;AAMAzD,kBAAMI,KAAN,CAAYE,MAAZ,CAAmBC,IAAnB,IAA2BgD,QAAQE,gBAAR,CAAyBC,IAAzB,CAA8B,MAA9B,CAA3B;AACA1D,kBAAMI,KAAN,CAAYE,MAAZ,CAAmBE,KAAnB,IAA4B+C,QAAQE,gBAAR,CAAyBC,IAAzB,CAA8B,OAA9B,CAA5B;AACA1D,kBAAMI,KAAN,CAAYE,MAAZ,CAAmBG,QAAnB,IAA+B8C,QAAQE,gBAAR,CAAyBC,IAAzB,CAA8B,UAA9B,CAA/B;AACA1D,kBAAMI,KAAN,CAAYE,MAAZ,CAAmBI,KAAnB,IAA4B6C,QAAQE,gBAAR,CAAyBC,IAAzB,CAA8B,OAA9B,CAA5B;;AAEA,gBAAIC,YAAY,EAAhB;;AAEA,gBAAI,CAACJ,QAAQE,gBAAR,CAAyBzC,MAA9B,EACI2C,YAAY,yCAAyCjE,IAAzC,EAAZ;AACJ,gBAAI,CAAC6D,QAAQC,SAAT,IAAsB,CAACD,QAAQC,SAAR,CAAkBxC,MAA7C,EACI2C,YAAY,8BAA8BjE,IAA9B,EAAZ;;AAEJ,gBAAIiE,SAAJ,EAAe;AACXtE,kBAAEC,KAAF,CAAQG,KAAR,CAAc,EAAED,SAASmE,SAAX,EAAd;AACA;AACH;;AAED3D,kBAAMI,KAAN,CAAYO,YAAZ,GAA2B,IAA3B;AACA,wCAAQ4B,IAAR,CAAagB,OAAb,EAAsBb,IAAtB,CAA2B,UAACC,IAAD,EAAU;AACjC3C,sBAAMI,KAAN,CAAYC,IAAZ,GAAmB,EAAnB;AACAL,sBAAMI,KAAN,CAAYO,YAAZ,GAA2B,KAA3B;AACAtB,kBAAEC,KAAF,CAAQC,MAAR,CAAe,EAAEC,SAAS,iCAAiCE,IAAjC,KAA0C6D,QAAQC,SAAlD,GAA8D,GAAzE,EAAf;;AAEA,oBAAMrD,SAAUwC,KAAKH,SAAL,IAAkBG,KAAKH,SAAL,CAAerC,MAAlC,IAA6C,EAA5D;AACAH,sBAAM4C,aAAN,CAAoBzC,MAApB;;AAEAH,sBAAM+C,YAAN,CAAmB,YAAnB;AACH,aATD,EASGF,KATH,CASS,UAACC,GAAD,EAAS;AACd9C,sBAAMI,KAAN,CAAYO,YAAZ,GAA2B,KAA3B;AACAtB,kBAAEC,KAAF,CAAQG,KAAR,CAAc,EAAED,SAASsD,IAAItD,OAAf,EAAd;AACAoE,wBAAQnE,KAAR,CAAcqD,GAAd;AACH,aAbD;AAeH,SA7CD;;AA+CAjE,yBAAiB,sBAAGgF,IAAH,CAAQ9D,KAAK,CAAL,CAAR,EAAiBC,KAAjB,CAAjB;AACA,eAAO,4BAAQuC,IAAR,CAAa,EAAEC,WAAW,CAAb,EAAb,EACFE,IADE,CACG,UAACC,IAAD,EAAU;AACZ,gBAAMxC,SAAUwC,KAAKH,SAAL,IAAkBG,KAAKH,SAAL,CAAerC,MAAlC,IAA6C,EAA5D;AACAH,kBAAM4C,aAAN,CAAoBzC,MAApB;AACH,SAJE,EAKF0C,KALE,CAKI,UAACC,GAAD,EAAS;AACZzD,cAAEC,KAAF,CAAQG,KAAR,CAAc,EAAED,SAASsD,IAAItD,OAAf,EAAd;AACAoE,oBAAQnE,KAAR,CAAcqD,GAAd;AACH,SARE,CAAP;AASH,KA3ID;;AA6IA,QAAMgB,eAAe,SAAfA,YAAe,CAAC/D,IAAD,EAAU;AAC3BA,eAAOV,EAAEU,IAAF,EAAQL,IAAR,EAAP;AACAd,oBAAY,kBAAQmF,iBAAR,CAA0BhE,IAA1B,EAAgC;AACxCiE,mBAAO,mBAAmBtE,IAAnB,EADiC;AAExCuE,uBAAW,KAF6B;AAGxCC,yBAAa,KAH2B;AAIxCC,yBAAa,IAJ2B;AAKxCC,yBAAa,KAL2B;AAMxCC,mBAAO,GANiC;AAOxCC,uBAAW,EAP6B;AAQxC,+BAAmB,IARqB;AASxCC,mBAAO,iBAAM;AACT1F,kCAAkBA,eAAegB,MAAf,EAAlB;AACAhB,iCAAiB,IAAjB;AACAD,0BAAUgB,OAAV;AACAhB,4BAAY,IAAZ;AACH;AAduC,SAAhC,CAAZ;AAgBAA,kBAAU4F,KAAV,CAAgB;AACZC,uBAAW,OADC;AAEZC,uBAAW,IAFC;AAGZ/B,kBAAM;AAHM,SAAhB;AAKA7C,mBAAWC,IAAX,EAAiB2C,IAAjB,CAAsB,YAAM;AACxB9D,sBAAU+F,MAAV,CAAiB,MAAjB;AACH,SAFD;AAGH,KA1BD;;AA4BO,QAAMC,sBAAO,SAAPA,IAAO,CAACC,SAAD,EAAe;AAC/BA,kBAAUC,KAAV,CAAgB,YAAM;AAClB,gBAAI,CAAClG,SAAL,EACIkF,8BADJ,KAGIlF,UAAUmG,SAAV;AACP,SALD;AAMH,KAPM;;sBASQ;AACXH;AADW,K","file":"token.js","sourcesContent":["/* created by apoorv, on Jan 31 2017 */\nimport liveapi from 'websockets/binary_websockets';\nimport windows from 'windows/windows';\nimport rv from 'common/rivetsExtra';\nimport moment from 'moment';\nimport clipboard from 'clipboard';\nimport html from 'text!token/token.html';\nimport {find} from 'lodash';\nimport 'css!token/token.css';\n\nlet token_win = null;\nlet token_win_view = null;\n\n/* rivetjs clipboard copy binder */\nrv.binders['clipboard'] = {\n    routine: (el, text) => {\n        const clip = new clipboard(el, {\n            text: (trigger) => {\n                return text;\n            }\n        });\n\n        clip.on('success', () => {\n            $.growl.notice({ message: 'Copied \"' + text + '\"' });\n        });\n\n        clip.on('error', () => {\n            $.growl.error({ message: 'Your browser doesn\\'t support copy to clipboard'.i18n() });\n        });\n\n        el._rv_clipboard_ && el._rv_clipboard_.destroy();\n        el._rv_clipboard_ = clip;\n    },\n    unbind: (el) => {\n        el._rv_clipboard_.destroy();\n    }\n};\n\nconst init_state = (root) => {\n    const state = {\n        route: 'token-list',\n        search_input: '',\n        tokens: [],\n        token: {\n            name: '',\n            scopes: {\n                read: true,\n                trade: false,\n                payments: false,\n                admin: false\n            },\n            btn_disabled: false,\n            checkTokenName: (e,scope) => {\n              let token_name = scope.token.name;\n              if(token_name.length > 32){\n                $.growl.error({message:\"Token name can have a maximum of 32 characters\".i18n()});\n                scope.token.name = token_name.substr(0,32);\n              }\n              if(token_name.match(/[^\\w\\s]+/g) != null){\n                $.growl.error({message:\"Token name can contain alphanumeric characters with spaces and underscores\".i18n()});\n                scope.token.name = token_name.replace(/[^\\w\\s]+/g, \"\");\n              }\n            }\n        },\n        confirm: {\n            visible: false,\n            top: '0px',\n            token: {}\n        }\n    };\n\n    state.tokens_filtered = () => {\n        const txt = state.search_input.toLowerCase();\n        return state.tokens.filter((token) => {\n            return txt === '' || token.display_name.toLowerCase().indexOf(txt) !== -1 || token.token.toLowerCase().indexOf(txt) !== -1 || token.permissions.toLowerCase().indexOf(txt) !== -1;\n        });\n    }\n\n    state.confirm.show = (e) => {\n        const span = $(e.target);\n        const top = span.position().top - span.parent().parent().height();\n        let token = span.attr('token-id');\n        token = find(state.tokens, { token: token });\n        state.confirm.top = top + 'px';\n        state.confirm.visible = true;\n        state.confirm.token = token;\n\n    }\n    state.confirm.no = () => {\n        state.confirm.visible = false;\n    }\n    state.confirm.yes = () => {\n        const token = state.confirm.token;\n        state.confirm.visible = false;\n        liveapi.send({ api_token: 1, delete_token: token.token })\n            .then((data) => {\n                const tokens = (data.api_token && data.api_token.tokens) || [];\n                state.update_tokens(tokens);\n            })\n            .catch((err) => {\n                $.growl.error({ message: err.message });\n            });\n    }\n\n    state.change_route = (route) => {\n        if (route !== 'token-list')\n            state.confirm.visible = false;\n        state.route = route;\n    }\n    state.update_tokens = (tokens) => {\n        tokens.forEach((token) => {\n            const scopes = token.scopes;\n            token.permissions = scopes.length == 4 ? 'All' : scopes.join(', ');\n\n            token.last_used_tooltip = token.last_used;\n            token.last_used = token.last_used ? moment.utc(token.last_used, 'YYYY-MM-DD HH:mm:ss').fromNow() : '-';\n        });\n        state.tokens = tokens;\n    }\n\n    state.token.add = () => {\n        if(state.token.name.length < 2){\n          $.growl.error({message:\"Token name must contain atleast 2 characters\".i18n()});\n          return;\n        }\n\n        const request = {\n            api_token: 1,\n            new_token: state.token.name,\n            new_token_scopes: []\n        };\n\n        state.token.scopes.read && request.new_token_scopes.push('read');\n        state.token.scopes.trade && request.new_token_scopes.push('trade');\n        state.token.scopes.payments && request.new_token_scopes.push('payments');\n        state.token.scopes.admin && request.new_token_scopes.push('admin');\n\n        let error_msg = '';\n\n        if (!request.new_token_scopes.length)\n            error_msg = 'Please choose at least one token scope'.i18n();\n        if (!request.new_token || !request.new_token.length)\n            error_msg = 'Please enter the token name'.i18n();\n\n        if (error_msg) {\n            $.growl.error({ message: error_msg });\n            return;\n        }\n\n        state.token.btn_disabled = true;\n        liveapi.send(request).then((data) => {\n            state.token.name = '';\n            state.token.btn_disabled = false;\n            $.growl.notice({ message: 'Successfully added new token \"'.i18n() + request.new_token + '\"' });\n\n            const tokens = (data.api_token && data.api_token.tokens) || [];\n            state.update_tokens(tokens);\n\n            state.change_route('token-list');\n        }).catch((err) => {\n            state.token.btn_disabled = false;\n            $.growl.error({ message: err.message });\n            console.error(err);\n        });\n\n    }\n\n    token_win_view = rv.bind(root[0], state);\n    return liveapi.send({ api_token: 1 })\n        .then((data) => {\n            const tokens = (data.api_token && data.api_token.tokens) || [];\n            state.update_tokens(tokens);\n        })\n        .catch((err) => {\n            $.growl.error({ message: err.message });\n            console.error(err);\n        });\n}\n\nconst initTokenWin = (root) => {\n    root = $(root).i18n();\n    token_win = windows.createBlankWindow(root, {\n        title: 'Token management'.i18n(),\n        resizable: false,\n        collapsable: false,\n        minimizable: true,\n        maximizable: false,\n        width: 700,\n        minHeight: 60,\n        'data-authorized': true,\n        close: () => {\n            token_win_view && token_win_view.unbind();\n            token_win_view = null;\n            token_win.destroy();\n            token_win = null;\n        }\n    });\n    token_win.track({\n        module_id: 'token',\n        is_unique: true,\n        data: null\n    });\n    init_state(root).then(() => {\n        token_win.dialog('open');\n    })\n}\n\nexport const init = ($menuLink) => {\n    $menuLink.click(() => {\n        if (!token_win)\n            initTokenWin(html);\n        else\n            token_win.moveToTop();\n    });\n}\n\nexport default {\n    init\n}\n"]}