"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define(["jquery","charts/chartWindow","common/rivetsExtra"],function(a,b,c){require(["text!trade/tradeTemplateManager.html"]),local_storage.get("trade-templates")||local_storage.set("trade-templates",[]);var d=function(){function b(a,d){var e=this;_classCallCheck(this,b);var f=this,g=local_storage.get("trade-templates");g.forEach(function(a){a.random&&a.template_type||(a=f.setRandom(a))}),local_storage.set("trade-templates",g);var h=this.init_state(a,d);require(["text!trade/tradeTemplateManager.html"],function(b){a.append(b.i18n()),e.view=c.bind(a[0],h)})}return _createClass(b,[{key:"init_state",value:function(b,c){var d=this,e={route:{value:"menu"},menu:{},templates:{array:local_storage.get("trade-templates"),save_as_value:"",rename_tmpl:null,rename_value:"",current:null}},f=e.route,g=e.templates,h=e.menu,i=this.setRandom(c.get_template());return g.array=local_storage.get("templates"),-1!==_.findIndex(g.array,function(a){return a.random===i.random})&&(g.current=i),f.update=function(a){f.value=a},h.save_as=function(){var a=c.get_template();a.name=a.categories_value+" "+_.capitalize(a.categoriy_displays_selected),g.save_as_value=a.name,f.update("save-as")},h.templates=function(){g.array=local_storage.get("trade-templates"),f.update("templates")},h.save_changes=function(){var b=d.setRandom(c.get_template()),e=b.name,f=local_storage.get("trade-templates"),h=_.findIndex(f,function(a){return a.name===e});-1!==h?f[h]=b:f.push(b),local_storage.set("trade-templates",f),g.array=f,g.current=b,a.growl.notice({message:"Template changes saved ".i18n()+"("+b.name+")"})},h.open_file_selector=function(){a(b).find("input[type=file]").click()},h.upload=function(b){var c=d,e=b.target.files[0];if(b.target.files=null,b.target.value=null,e){var f=new FileReader;f.onload=function(b){var d=b.target.result,e=local_storage.get("trade-templates"),f=null;try{f=JSON.parse(d),f.name=f.name.substring(0,20).replace(/[<>]/g,"-");var h=f.random;if(f=c.setRandom(f),h!==f.random)throw"Invalid JSON file".i18n();if(c.isDuplicate(f,e))return;if("trade-template"!==f.template_type)throw"Invalid template type.".i18n()}catch(b){return void a.growl.error({message:b})}for(var i=1,j=f.name;;){if(!e.map(function(a){return a.name}).includes(j)){f.name=j;break}j=f.name+" ("+i+")",i++}g.apply(f),e.push(f),local_storage.set("trade-templates",e),g.array=e,a.growl.notice({message:"Successfully applied the template and saved it as ".i18n()+"<b>"+f.name+"</b>"})},f.readAsText(e)}},g.save_as=function(b){b.preventDefault();var e=g.save_as_value.substring(0,20).replace(/[<>]/g,"-"),h=d.setRandom(c.get_template());if(h){h.name=e;var i=local_storage.get("trade-templates");if(i.map(function(a){return a.name}).includes(e))return void a.growl.error({message:"Template name already exists".i18n()});if(d.isDuplicate(h,i))return;i.push(h),g.current=h,local_storage.set("trade-templates",i),g.array=i,f.update("menu"),c.set_template(h)}},g.download=function(b){var c=JSON.stringify(b);download_file_in_browser(b.name+".json","text/json;charset=utf-8;",c),a.growl.notice({message:"Downloading template as <b>".i18n()+b.name+".json</b>"})},g.remove=function(a){var b=local_storage.get("trade-templates");g.array=b.filter(function(b){return b.name!==a.name}),local_storage.set("trade-templates",g.array),g.current&&a.name===g.current.name&&(g.current=null)},g.rename=function(a){g.rename_value=a.name,g.rename_tmpl=a,f.update("rename")},g.do_rename=function(b){b.preventDefault();var e=g.rename_tmpl.name,h=g.rename_value.substring(0,20).replace(/[<>]/g,"-"),i=local_storage.get("trade-templates");if(i.map(function(a){return a.name}).includes(h))return void a.growl.error({message:"Template name already exists".i18n()});var j=i.find(function(a){return a.name===e});if(j){j.name=h,local_storage.set("trade-templates",i),g.array=i,f.update("templates");var k=d.setRandom(c.get_template());k.random==j.random&&(k.name=h,c.set_template(k),g.current=k)}},g.apply=function(a){c.set_template(a),g.current=a,f.update("menu"),c.hide_template_menu()},g.confirm=function(a,b){f.update("confirm");var c=b.currentTarget.text;g.confirm_prevMenu=c==="Delete".i18n()?"templates":"menu",g.confirm_text=c==="Delete".i18n()?"Are you sure you want to delete template?".i18n():"Are you sure you want to overwrite current template?".i18n(),g.confirm_yes=function(){c==="Delete".i18n()?(g.remove(a),g.current===a&&(g.current=null)):h.save_changes(),g.confirm_no()},g.confirm_no=function(){f.update(g.confirm_prevMenu)}},e}},{key:"setRandom",value:function(a){var b=a.name;return delete a.name,delete a.random,a.template_type="trade-template",a.random=this.hashCode(JSON.stringify(a)),a.name=b,a}},{key:"hashCode",value:function(a){return a.split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0)}},{key:"isDuplicate",value:function(b,c){var d=c.find(function(a){return a.random==b.random?a:void 0});return d?(a.growl.error({message:"Template already saved as ".i18n()+"<b>"+d.name+"</b>."}),!0):!1}},{key:"unbind",value:function(){this.view&&this.view.unbind(),this.view=null}}]),b}();return{init:function(a,b){return new d(a,b)}}});