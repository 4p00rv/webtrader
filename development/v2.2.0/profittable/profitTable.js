define(["exports","jquery","lodash","../windows/windows","../websockets/binary_websockets","../viewtransaction/viewTransaction","text!./profitTable.html","binary-longcode","datatables","jquery-growl","../common/util","css!./profitTable.css"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.init=void 0;var j=i(b),k=i(c),l=i(d),m=i(e),n=i(f),o=i(g),p=null,q=null,r=local_storage.get("currency"),s=null,t=a.init=function(a){a.click(function(){p?p.moveToTop():m["default"].cached.authorize().then(y)["catch"](function(a){j["default"].growl.error({message:a.message})})})},u=!1,v=!1,w=function(a){var b=j["default"]("#"+q.attr("id")+"_processing").css("top","200px").show();u=!0;var c={profit_table:1,description:1,sort:"DESC"};if("string"==typeof a){c.date_from=yyyy_mm_dd_to_epoch(a,{utc:!0});var d=Date.UTC(1970,0,1,23,59,59)/1e3;c.date_to=c.date_from+d,q.api().rows().remove(),v=!0}else c.limit=50,(v||a.clear)&&(q.api().rows().remove(),v=!1),c.offset=q.api().column(0).data().length;var e=function(a){var c=(local_storage.get("i18n")||{value:"en"}).value,d=local_storage.get("active_symbols"),e=new h.Longcode(d,c,r),f=a.profit_table&&a.profit_table.transactions||[],g=f.map(function(a){var b=(parseFloat(a.sell_price)-parseFloat(a.buy_price)).toFixed(2),c="<button>View</button>".i18n();try{e.get(a.shortcode)}catch(d){}return[epoch_to_string(a.purchase_time,{utc:!0}),a.transaction_id,e.get(a.shortcode),formatPrice(a.buy_price,r),epoch_to_string(a.sell_time,{utc:!0}),formatPrice(a.sell_price,r),b,c,a]});q.api().rows.add(g),q.api().draw(),u=!1,b.hide()};m["default"].send(c).then(e)["catch"](function(a){e({}),j["default"].growl.error({message:a.message})})},x=function(a){var b=a.target,c=j["default"](b);if("BUTTON"===b.tagName&&!c.hasClass("button-disabled")){var d=b.parentElement.parentElement,e=q.api().row(d).data();e=k["default"].last(e),c.addClass("button-disabled"),n["default"].init(e.contract_id,e.transaction_id).then(function(){return c.removeClass("button-disabled")})["catch"](function(a){return void 0})}},y=function(){p=l["default"].createBlankWindow(j["default"]("<div/>"),{title:"Profit Table".i18n(),width:700,height:400,destroy:function(){q&&q.DataTable().destroy(!0),p=null},refresh:function(){s.clear(),w({clear:!0})},"data-authorized":"true"}),p.track({module_id:"profitTable",is_unique:!0,data:null}),q=j["default"](o["default"]).i18n(),q.appendTo(p);var a=j["default"]("<div/>").addClass("profit-table-info");q=q.dataTable({data:[],columnDefs:[{targets:6,createdCell:function(a,b){var c=0>b?"red":b>0?"green":"bold";c&&j["default"](a).addClass(c),j["default"](a).attr("data-src",b),a.textContent=formatPrice(b,r)}}],info:!1,footerCallback:function(){var b=this.api(),c=b.column(6).data().reduce(function(a,b){return 1*a+1*b},0),d="total "+(c>=0?"green":"red");a.html('<span class="title">Total Profit/Loss<span><span class="'+d+'">'+formatPrice(c,r)+"</span>")},paging:!1,ordering:!1,searching:!0,processing:!0}),a.i18n().appendTo(q.parent()),q.parent().addClass("hide-search-input"),q.api().columns().every(function(){var a=this;j["default"]("input",this.header()).on("keyup change",function(){a.search()!==this.value&&a.search(this.value).draw()})}),w({clear:!0}),s=p.addDateToHeader({title:"Jump to: ".i18n(),date:null,changed:w,cleared:w}),p.dialog("open"),p.on("click",x),p.scroll(function(){var a=p.scrollTop(),b=p.innerHeight(),c=p[0].scrollHeight,d=(a+b)/c;d>.75&&!u&&!v&&w({clear:!1})})};a["default"]={init:t}});