define(["exports","babel-runtime/regenerator","jquery","../windows/windows","../websockets/binary_websockets","binary-longcode","jquery-ui","datatables","jquery-growl","css!./portfolio.css"],function(a,b,c,d,e,f){"use strict";function g(a){return a&&a.__esModule?a:{"default":a}}function h(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(i){return void c(i)}return g.done?void a(h):Promise.resolve(h).then(function(a){d("next",a)},function(a){d("throw",a)})}return d("next")})}}Object.defineProperty(a,"__esModule",{value:!0}),a.proposal_open_contract=a.init=void 0;var i=g(b),j=g(c),k=g(d),l=g(e),m=null,n=null,o=null,p="USD",q=[],r=null,s=a.init=function(a){a.click(function(){m?m.moveToTop():y()})},t=function(a){if(!a.error){var b=a.proposal_open_contract,c=b.contract_id,d=b.bid_price;if(n){var e=n.api().row("#"+c),f=e.data();if(!f)return;var g=f[3];f[3]=d,e.data(f);var h=n.find("#"+c);b.is_valid_to_sell?(h.removeClass("resale-not-offered"),g!==d&&h.removeClass("indicative-red indicative-green").addClass(1*d>1*g?"indicative-green":"indicative-red")):h.removeClass("indicative-red indicative-green").addClass("resale-not-offered")}}},u=!1,v=0;l["default"].events.on("logout",function(){u=!1,v=0});var w=function D(a){if("subscribe"===a)++v,!u&&v>0&&l["default"].send({proposal_open_contract:1,subscribe:1}).then(function(){u=!0})["catch"](function(a){j["default"].growl.error({message:a.message})});else if("forget"===a)--v,u&&0===v&&l["default"].send({forget_all:"proposal_open_contract"}).then(function(){u=!1})["catch"](function(a){u=!1});else{if("resubscribe"!==a)return;l["default"].send({forget_all:"proposal_open_contract"}).then(function(){u=!1,--v,D("subscribe")})["catch"](function(a){u=!1})}},x=function(a){var b=a.target,c=j["default"](b);if("BUTTON"===b.tagName&&!c.hasClass("button-disabled")){var d=b.parentElement.parentElement,e=n.api().row(d).data();e=_.last(e),c.addClass("button-disabled"),require(["viewtransaction/viewTransaction"],function(a){a.init(e.contract_id,e.transaction_id).then(function(){return c.removeClass("button-disabled")})["catch"](function(){c.removeClass("button-disabled")})})}},y=function(){var a=l["default"].events.on("balance",function(a){void 0!==a.balance&&void 0!==a.balance.currency&&(p=a.balance.currency,o&&o&&o.update(a.balance.balance))}),b=(local_storage.get("i18n")||{value:"en"}).value,c=local_storage.get("active_symbols"),d=l["default"].events.on("transaction",function(a){var d=a.transaction;if(r||(r=new f.Longcode(c,b,p)),"buy"===d.action){var e="<button>View</button>".i18n(),g=[d.transaction_id,r.get(d.shortcode),Math.abs(d.amount),"0.00",e,d.contract_id,d];d.date_expiry&&l["default"].sell_expired(d.date_expiry),n.api().rows.add([g]),n.api().draw(),z([d])}else if("sell"===d.action){var h=n.find("#"+d.contract_id)[0];n.api().row(h).remove(),n.api().draw(),A([d])}});l["default"].send({balance:1}).then(function(b){m=k["default"].createBlankWindow(j["default"]("<div/>"),{title:"Portfolio".i18n(),width:700,height:400,"data-authorized":"true",close:function(){A(q),l["default"].events.off("proposal_open_contract",t)},open:function(){B(),l["default"].events.on("proposal_open_contract",t)},destroy:function(){n&&n.DataTable().destroy(!0),m=null,l["default"].events.off("balance",a),l["default"].events.off("transaction",d)},refresh:function(){l["default"].send({balance:1})["catch"](function(a){j["default"].growl.error({message:a.message})}),A(q).then(B)}});var c=m.parent().find(".ui-dialog-title").addClass("with-content");o=j["default"]('<span class="span-in-dialog-header" />').insertAfter(c),o.update=function(a){o.html("Account balance: <strong>".i18n()+formatPrice(a,e)+"</strong>")};var e=b.balance.currency;n=j["default"]("<table width='100%' class='portfolio-dialog hover'/>"),n.appendTo(m),n=n.dataTable({data:[],columns:[{title:"Ref.".i18n()},{title:"Contract Details".i18n()},{title:"Purchase".i18n(),render:function(a){return'<span class="bold">'+formatPrice(a,e)+"</span>"}},{title:"Indicative".i18n(),render:function(a){return'<span class="bold">'+formatPrice(a,e)+"</span>"}},{title:""}],rowId:"5",paging:!1,ordering:!1,processing:!0}),n.parent().addClass("hide-search-input"),m.on("click",x),m.track({module_id:"portfolio",is_unique:!0,data:null}),m.dialog("open")})["catch"](function(a){return void 0})},z=function(a){a.forEach(function(a){q.push(a),l["default"].proposal_open_contract.subscribe(a.contract_id)["catch"](function(a){return void 0})})},A=function(a){var b=a.map(function(a){return l["default"].proposal_open_contract.forget(a.contract_id)["catch"](function(a){return j["default"].growl.error({message:a.message})})}),c=_.map(a,"contract_id");return q=q.filter(function(a){return _.includes(c,a.contract_id)===!1}),Promise.all(b)},B=function(){var a=h(i["default"].mark(function b(){var a,c,d,e,g,h,k;return i["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return a=j["default"]("#"+n.attr("id")+"_processing").show(),c=(local_storage.get("i18n")||{value:"en"}).value,d=local_storage.get("active_symbols"),r||(r=new f.Longcode(d,c,p)),b.prev=4,b.next=7,l["default"].send({portfolio:1});case 7:e=b.sent,g=e.portfolio&&e.portfolio.contracts,h="<button>View</button>".i18n(),k=g.map(function(a){return[a.transaction_id,r.get(a.shortcode),a.buy_price,"0.00",h,a.contract_id,a]}),g.forEach(function(a){return l["default"].sell_expired(a.expiry_time)}),z(g),n.api().rows().remove(),n.api().rows.add(k),n.api().draw(),a.hide(),b.next=26;break;case 19:b.prev=19,b.t0=b["catch"](4),n.api().rows().remove(),n.api().draw(),a.hide(),j["default"].growl.error({message:b.t0.message});case 26:case"end":return b.stop()}},b,void 0,[[4,19]])}));return function(){return a.apply(this,arguments)}}(),C=a.proposal_open_contract={subscribe:function(){return w("subscribe")},forget:function(){return w("forget")},resubscribe:function(){return w("resubscribe")}};a["default"]={init:s,proposal_open_contract:C}});