{"version":3,"sources":["../../../../src/statement/statement.es6"],"names":["statement","table","datepicker","currency","local_storage","get","init","$menuLink","click","cached","authorize","then","initStatement","catch","err","console","error","moveToTop","loading","options","offset","limit","is_specific_date_shown","refreshTable","yyy_mm_dd","processing_msg","attr","css","show","lng","value","active_symbols","longcodeGenerator","request","description","date_from","yyyy_mm_dd_to_epoch","utc","one_day_utc","Date","UTC","date_to","api","rows","remove","clear","column","data","length","refresh","transactions","view_button_text","i18n","map","trans","view_button_class","includes","action_type","view_button","amount","epoch_to_string","transaction_time","transaction_id","capitalize","test","shortcode","longcode","toFixed","formatPrice","balance_after","add","draw","hide","send","growl","message","createBlankWindow","title","width","height","close","DataTable","destroy","track","module_id","is_unique","appendTo","dataTable","td","cellData","css_class","addClass","textContent","paging","ordering","searching","processing","closest","columns","every","header","on","search","addDateToHeader","date","changed","cleared","on_arrow_click","dialog","scroll","scrollTop","innerHeight","scrollHeight","postion","e","target","$target","tagName","hasClass","tr","parentElement","transaction","row","last","contract_id","removeClass"],"mappings":"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","file":"statement.js","sourcesContent":["ï»¿/**\n * Created by amin on November 9, 2015.\n */\nimport $ from \"jquery\";\nimport windows from \"../windows/windows\";\nimport liveapi from \"../websockets/binary_websockets\";\nimport _ from \"lodash\";\nimport \"datatables\";\nimport \"jquery-growl\";\nimport 'css!./statement.css';\nimport html from 'text!./statement.html';\nimport viewTransaction from '../viewtransaction/viewTransaction';\nimport { Longcode } from 'binary-longcode';\n\nlet statement = null,\n   table = null,\n   datepicker = null,\n   currency=local_storage.get(\"currency\");\n\nexport const init = ($menuLink) => {\n   $menuLink.click(() => {\n      if (!statement)\n         liveapi.cached.authorize()\n            .then(initStatement)\n            .catch(\n               (err) => console.error(err)\n            );\n      else\n         statement.moveToTop();\n   });\n};\n\nlet loading = false;\nconst options = { offset : 0, limit: 200 };\nlet is_specific_date_shown = false; /* is data for a specific date is shown */\n\nconst refreshTable  = (yyy_mm_dd) => {\n   const processing_msg = $('#' + table.attr('id') + '_processing').css('top','200px').show();\n   loading = true;\n   const lng = (local_storage.get('i18n') || {value:'en'}).value;\n   const currency = local_storage.get('currency') || 'USD';\n   const active_symbols = local_storage.get('active_symbols');\n   const longcodeGenerator = new Longcode(active_symbols, lng, currency);;\n\n   const request = {\n      statement: 1,\n      description: 1\n   };\n\n   /* if a date is specified get the transactions for that date */\n   if (typeof yyy_mm_dd === 'string') {\n      request.date_from = yyyy_mm_dd_to_epoch(yyy_mm_dd, { utc: true });\n      const one_day_utc = Date.UTC(1970, 0, 1, 23, 59, 59) / 1000;\n      request.date_to = request.date_from + one_day_utc;\n      table.api().rows().remove();\n      is_specific_date_shown = true;\n   }\n   else  { /* request the next 50 items for live scroll */\n      request.limit = 50;\n      if(is_specific_date_shown || yyy_mm_dd.clear) {\n         table.api().rows().remove();\n         is_specific_date_shown = false;\n      }\n      request.offset = table.api().column(0).data().length;\n   }\n   \n   /* refresh the table with result of { profit_table:1 } from WS */\n   const refresh = (data) => {\n      const transactions = (data.statement && data.statement.transactions) || [];\n      const view_button_text = 'View'.i18n();\n      const rows = transactions.map((trans) => {\n         const view_button_class = _(['buy', 'sell']).includes(trans.action_type) ? '' : 'class=\"button-disabled\"';\n         const view_button = '<button '+view_button_class+'>' + view_button_text + '</button>';\n         const amount = trans.amount * 1;\n         return [\n            epoch_to_string(trans.transaction_time, { utc: true }),\n            trans.transaction_id,\n            _.capitalize(trans.action_type),\n            /(Buy|Sell)/i.test(trans.action_type) ? longcodeGenerator.get(trans.shortcode) : trans.longcode,\n            (trans.amount * 1).toFixed(2),\n            '<b>' + formatPrice(trans.balance_after,currency) + '</b>',\n            view_button,\n            trans, /* data for view transaction dailog - when clicking on arrows */\n         ];\n      });\n      table.api().rows.add(rows);\n      table.api().draw();\n      loading = false;\n      processing_msg.hide();\n   };\n\n   liveapi.send(request)\n      .then(refresh)\n      .catch((err) => {\n         refresh({});\n         $.growl.error({ message: err.message });\n         console.error(err);\n      });\n}\n\nconst initStatement = () => {\n   statement = windows.createBlankWindow($('<div/>'), {\n      title: 'Statement'.i18n(),\n      width: 700 ,\n      height: 400,\n      close: () => {\n         table && table.DataTable().destroy(true);\n         statement && statement.remove();\n         statement = null;\n      },\n      refresh: () => {\n         datepicker.clear();\n         refreshTable({clear:true});\n      },\n      'data-authorized' :'true'\n   });\n   statement.track({\n      module_id: 'statement',\n      is_unique: true,\n      data: null,\n   });\n\n   table = $(html).i18n();\n   table.appendTo(statement);\n\n   table = table.dataTable({\n      data: [],\n      \"columnDefs\": [ {\n         \"targets\": 4,\n         \"createdCell\": (td, cellData) => {\n            const css_class = (cellData < 0) ? 'red' : (cellData > 0) ? 'green' : 'bold';\n            if (css_class)\n               $(td).addClass(css_class);\n            td.textContent = formatPrice(cellData, currency);\n         }\n      }],\n      paging: false,\n      ordering: false,\n      searching: true,\n      processing: true,\n   });\n\n   table.closest('.ui-dialog-content').addClass('hide-search-input').addClass('statement-dialog-content');\n\n   // Apply the a search on each column input change\n   table.api().columns().every(function () {\n      const column = this;\n      $('input', this.header()).on('keyup change', function () {\n         if (column.search() !== this.value)\n            column.search(this.value) .draw();\n      });\n   });\n\n\n   datepicker = statement.addDateToHeader({\n      title: 'Jump to: ',\n      date: null, /* set date to null */\n      changed: refreshTable,\n      cleared: refreshTable\n   });\n\n   statement.on('click', on_arrow_click);\n   statement.dialog('open');\n\n\n   /**************** infinite scroll implementation *******************/\n   refreshTable({clear:true});\n   statement.scroll(() => {\n      const scrollTop = statement.scrollTop(),\n         innerHeight = statement.innerHeight(),\n         scrollHeight = statement[0].scrollHeight,\n         postion = (scrollTop + innerHeight) / scrollHeight;\n      if(postion > 0.75 && !loading && !is_specific_date_shown){\n         refreshTable({clear:false});\n      }\n   });\n\n};\n\nconst on_arrow_click = (e) =>{\n   const target = e.target;\n   const $target = $(target);\n   if(target.tagName !== 'BUTTON' || $target.hasClass('button-disabled'))\n      return;\n   const tr = target.parentElement.parentElement;\n   let transaction = table.api().row(tr).data();\n   transaction = _.last(transaction);\n   $target.addClass('button-disabled');\n   viewTransaction.init(transaction.contract_id, transaction.transaction_id)\n      .then(() => $target.removeClass('button-disabled')).catch((err)=>{});\n}\n\nexport default  { init }\n"]}