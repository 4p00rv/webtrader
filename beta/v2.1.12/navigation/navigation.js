define(["jquery","moment","lodash","common/rivetsExtra","text!navigation/countries.json","text!navigation/navigation.html","css!navigation/navigation.css","common/util"],function(a,b,c,d,e,f){"use strict";function g(){a("#nav-menu li > ul li").each(function(){var b=a(this);b.hasClass("update-list-item-handlers")||(b.addClass("update-list-item-handlers"),b.on("click",function(){var b=a(this),c=b.find("ul").length>0;c||b.parent("ul").hasClass("nav-closed")||b.parent("ul").not("#nav-menu").toggleClass("nav-closed")}))}),a("#nav-menu.nav-normal-menu li").each(function(){a(this).on("mouseover",function(){a(this).find("ul.nav-closed").each(function(){a(this).removeClass("nav-closed")})})})}function h(d){var f=d.find(".login"),g=d.find(".account").hide(),h=g.find("li.visible-on-real-accounts-only").hide(),i=g.find("li.upgrade-account").hide(),j=d.find("span.time"),k=d.find(".login button"),l=d.find(".account .logout"),m=d.find(".account span.login-id"),n=d.find(".account span.balance").fadeOut(),o="";local_storage.get("oauth")&&f.hide(),require(["websockets/binary_websockets"],function(b){function d(a){if(!o)return void b.send({payout_currencies:1}).then(function(b){o=b.payout_currencies[0],local_storage.set("currency",o),setTimeout(function(){d(a)},0)})["catch"](function(a){});var c="0";c=a.authorize?a.authorize.balance:a.balance?a.balance.balance:"0",n.text(formatPrice(c,o)).fadeIn()}b.events.on("balance",d),b.events.on("logout",function(){a(".webtrader-dialog[data-authorized=true]").dialog("close").dialog("destroy").remove(),l.removeAttr("disabled"),g.fadeOut(),f.fadeIn(),m.fadeOut(),n.fadeOut(),o="",local_storage.remove("currency")}),b.events.on("login",function(j){a(".webtrader-dialog[data-authorized=true]").dialog("close").dialog("destroy").remove(),f.fadeOut(),g.fadeIn(),d(j),m.text("Account "+j.authorize.loginid).fadeIn();var k=local_storage.get("oauth")||[],n=0===j.authorize.is_virtual;n?h.show():h.hide();var o=Cookies.loginids(),p=c.some(o,{is_real:!0})||c.some(k,{is_virtual:0}),q=(c.some(o,{is_disabled:!0}),!1);if(c.every(o,{is_financial:!1})&&!c.some(k,{is_financial:!0})&&n){var r=Cookies.residence();q=e[r]&&"maltainvest"===e[r].financial_company||"gb"===Cookies.residence()&&/^MLT/.test(j.authorize.loginid)}var s=function(a,b){a?b.show():b.hide()};s(!q,i.find(".upgrade-to-real-account-span")),s(q,i.find(".open-financial-account-span")),s(!p||q,i),a(".account li.info").remove(),k.forEach(function(c){if(c.id!==j.authorize.loginid){var d=a('<a href="#"></a>').html('<span class="ui-icon ui-icon-login"></span>'+c.id),e=a("<li/>").append(d).addClass("info");e.data(c),e.click(function(){var c=a(this).data();a(".account li.info").remove(),b.switch_account(c.id)["catch"](function(b){a.growl.error({message:b.message})})}),e.insertBefore(l.parent())}})}),k.on("click",function(){k.attr("disabled","disabled"),require(["oauth/login"],function(a){k.removeAttr("disabled"),a.init()})}),l.on("click",function(){b.invalidate(),l.attr("disabled","disabled")}),a(".login").on("login-error",function(){f.fadeIn()})}),j.text(b.utc().format("YYYY-MM-DD HH:mm")+" GMT"),setInterval(function(){j.text(b.utc().format("YYYY-MM-DD HH:mm")+" GMT")},15e3)}function i(a){a=a.find("#topbar").addBack("#topbar");var b={lang:{value:"en",name:"English"},confirm:{visible:!1},languages:[{value:"en",name:"English"},{value:"ar",name:"Arabic"},{value:"de",name:"Deutsch"},{value:"es",name:"Español"},{value:"fr",name:"Français"},{value:"id",name:"Bahasa Indonesia"},{value:"it",name:"Italiano"},{value:"pl",name:"Polish"},{value:"pt",name:"Português"},{value:"ru",name:"Русский"},{value:"vi",name:"Vietnamese"},{value:"zh_cn",name:"简体中文"},{value:"zh_tw",name:"繁體中文"}]};b.onclick=function(a){var d=c.find(b.languages,{value:a});d.value!=b.lang.value&&(local_storage.set("i18n",{value:d.value}),window.location.reload())};var e=(local_storage.get("i18n")||{value:"en"}).value;b.lang=c.find(b.languages,{value:e}),d.bind(a[0],b)}return e=JSON.parse(e),{init:function(b){var c=a(f).i18n();a("body").prepend(c),h(c),i(c),require(["themes/themes"]),g(),b&&b(a("#nav-menu")),is_beta()&&c.find("a.config").closest("li").show()},updateDropdownToggles:g}});