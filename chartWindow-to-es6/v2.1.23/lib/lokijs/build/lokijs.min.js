!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.loki=b()}(this,function(){return function(){"use strict";function a(a,b,c){var d,e;if(!a||!b||a===!0||b===!0){if(!(a!==!0&&a!==!1||b!==!0&&b!==!1))return c?a===b:a?!1:b;if(void 0===b||null===b||a===!0||b===!1)return c;if(void 0===a||null===a||a===!1||b===!0)return!0}return a===b?c:b>a?!0:a>b?!1:(d=a.toString(),e=b.toString(),d==e?c:e>d?!0:!1)}function b(a,b,c){var d,e;if(!a||!b||a===!0||b===!0){if(!(a!==!0&&a!==!1||b!==!0&&b!==!1))return c?a===b:a?!b:!1;if(void 0===a||null===a||a===!1||b===!0)return c;if(void 0===b||null===b||a===!0||b===!1)return!0}return a===b?c:a>b?!0:b>a?!1:(d=a.toString(),e=b.toString(),d==e?c:d>e?!0:!1)}function c(c,d,e){return c===d?0:a(c,d,!1)?e?1:-1:b(c,d,!1)?e?-1:1:0}function d(a,b,d){for(var e,f,g=0,h=0,i=a.length;i>h;h++)if(e=a[h],f=e[0],g=c(b[f],d[f],e[1]),0!==g)return g;return 0}function e(a,b,c,d,f){var g=f||0,h=b[g];if(void 0===a||null===a||!G.call(a,h))return!1;var i=!1,j=a[h];if(g+1>=b.length)i=c(j,d);else if(Array.isArray(j))for(var k=0,l=j.length;l>k&&(i=e(j[k],b,c,d,g+1),i!==!0);k+=1);else i=e(j,b,c,d,g+1);return i}function f(a){return"string"==typeof a||Array.isArray(a)?function(b){return-1!==a.indexOf(b)}:"object"==typeof a&&null!==a?function(b){return G.call(a,b)}:null}function g(a,b){for(var c in b)if(G.call(b,c))return I[c](a,b[c]);return!1}function h(a,b){if(null===a||void 0===a)return null;var c,d=b||"parse-stringify";switch(d){case"parse-stringify":c=JSON.parse(JSON.stringify(a));break;case"jquery-extend-deep":c=jQuery.extend(!0,{},a);break;case"shallow":c=Object.create(a.prototype||null),Object.keys(a).map(function(b){c[b]=a[b]})}return c}function i(a,b){var c,d=[];if("parse-stringify"==b)return h(a,b);for(c=a.length-1;0>=c;c--)d.push(h(a[c],b));return d}function j(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(a){return!1}}function k(){}function l(a,b){this.filename=a||"loki.db",this.collections=[],this.databaseVersion=1.1,this.engineVersion=1.1,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.throttledSaves=!0,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.throttledSavePending=!1,this.throttledCallbacks=[],this.verbose=b&&b.hasOwnProperty("verbose")?b.verbose:!1,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};var c=function(){return"undefined"==typeof window?"NODEJS":"undefined"!=typeof global&&global.window?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"};this.ENV=b&&b.hasOwnProperty("env")?b.env:c(),"undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(b,!0),this.on("init",this.clearChanges)}function m(a){this.hashStore={},this.options=a||{},this.options.hasOwnProperty("asyncResponses")||(this.options.asyncResponses=!1),this.options.hasOwnProperty("asyncTimeout")||(this.options.asyncTimeout=50)}function n(a,b){if(this.mode="reference",this.adapter=null,this.options=b||{},this.dbref=null,this.dbname="",this.pageIterator={},!a)throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction");if("reference"===a.mode)throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter");this.adapter=a,this.options.hasOwnProperty("paging")||(this.options.paging=!1),this.options.hasOwnProperty("pageSize")||(this.options.pageSize=26214400),this.options.hasOwnProperty("delimiter")||(this.options.delimiter="$<\n")}function o(){this.fs=require("fs")}function p(){}function q(a,b){return b=b||{},b.queryObj=b.queryObj||null,b.queryFunc=b.queryFunc||null,b.firstOnly=b.firstOnly||!1,this.collection=a,this.searchIsChained=!b.queryObj&&!b.queryFunc,this.filteredrows=[],this.filterInitialized=!1,"undefined"!=typeof b.queryObj&&null!==b.queryObj?this.find(b.queryObj,b.firstOnly):"undefined"!=typeof b.queryFunc&&null!==b.queryFunc?this.where(b.queryFunc):this}function r(a,b,c){this.collection=a,this.name=b,this.rebuildPending=!1,this.options=c||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new q(a),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,this.events={rebuild:[]}}function s(a,b){function c(a){var b="function"==typeof Set?new Set:[];b.add||(b.add=function(a){return-1===this.indexOf(a)&&this.push(a),this}),a.forEach(function(a){b.add(a.object)}),b.forEach(function(a){if(!G.call(a,"$loki"))return m.removeAutoUpdateObserver(a);try{m.update(a)}catch(b){}})}function d(a,b,c){m.changes.push({name:a,operation:b,obj:JSON.parse(JSON.stringify(c))})}function e(){m.changes=[]}function f(a){var b,c;if(a)if(Array.isArray(a))for(b=a.length,c=0;b>c;c++)a[c].hasOwnProperty("meta")||(a[c].meta={}),a[c].meta.created=(new Date).getTime(),a[c].meta.revision=0;else a.meta||(a.meta={}),a.meta.created=(new Date).getTime(),a.meta.revision=0}function g(a){a&&(a.meta.updated=(new Date).getTime(),a.meta.revision+=1)}function h(a){d(m.name,"I",a)}function i(a){d(m.name,"U",a)}function j(a){f(a),h(a)}function k(a){g(a),i(a)}function l(){p=m.disableChangesApi?f:j,q=m.disableChangesApi?g:k}this.name=a,this.data=[],this.idIndex=[],this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=a,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var m=this;b=b||{},b.hasOwnProperty("unique")&&(Array.isArray(b.unique)||(b.unique=[b.unique]),b.unique.forEach(function(a){m.uniqueNames.push(a),m.constraints.unique[a]=new D(a)})),b.hasOwnProperty("exact")&&b.exact.forEach(function(a){m.constraints.exact[a]=new E(a)}),this.adaptiveBinaryIndices=b.hasOwnProperty("adaptiveBinaryIndices")?b.adaptiveBinaryIndices:!0,this.transactional=b.hasOwnProperty("transactional")?b.transactional:!1,this.cloneObjects=b.hasOwnProperty("clone")?b.clone:!1,this.cloneMethod=b.hasOwnProperty("cloneMethod")?b.cloneMethod:"parse-stringify",this.asyncListeners=b.hasOwnProperty("asyncListeners")?b.asyncListeners:!1,this.disableChangesApi=b.hasOwnProperty("disableChangesApi")?b.disableChangesApi:!0,this.autoupdate=b.hasOwnProperty("autoupdate")?b.autoupdate:!1,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(b.ttl||-1,b.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],"delete":[],warning:[]},this.changes=[],this.ensureId();var n=[];if(b&&b.indices)if("[object Array]"===Object.prototype.toString.call(b.indices))n=b.indices;else{if("string"!=typeof b.indices)throw new TypeError("Indices needs to be a string or an array of strings");n=[b.indices]}for(var o=0;o<n.length;o++)this.ensureIndex(n[o]);this.observerCallback=c,this.getChanges=function(){return m.changes},this.flushChanges=e;var p,q;l(),this.setChangesApi=function(a){m.disableChangesApi=!a,l()},this.on("insert",function(a){p(a)}),this.on("update",function(a){q(a)}),this.on("delete",function(a){m.disableChangesApi||d(m.name,"R",a)}),this.on("warning",function(a){m.{var c=a-b,d=c*c;return d}),d=x(c),e=Math.sqrt(d);return e}function z(a,b,c){if(c===!1)return a[b];for(var d=b.split("."),e=a;d.length>0;)e=e[d.shift()];return e}function A(a,b,c){for(var d,e,f=0,g=a.length;g>f;){if(e=f+g>>1,d=c.apply(null,[b,a[e]]),0===d)return{found:!0,index:e};0>d?g=e:f=e+1}return{found:!1,index:g}}function B(a){return function(b,c){return A(b,c,a)}}function C(){}function D(a){this.field=a,this.keyMap={},this.lokiMap={}}function E(a){this.index={},this.field=a}function F(a){this.field=a}var G=Object.prototype.hasOwnProperty,H={copyProperties:function(a,b){var c;for(c in a)b[c]=a[c]},resolveTransformObject:function(a,b,c){var d,e;if("number"!=typeof c&&(c=0),++c>=10)return a;for(d in a)"string"==typeof a[d]&&0===a[d].indexOf("[%lktxp]")?(e=a[d].substring(8),b.hasOwnProperty(e)&&(a[d]=b[e])):"object"==typeof a[d]&&(a[d]=H.resolveTransformObject(a[d],b,c));return a},resolveTransformParams:function(a,b){var c,d,e=[];if("undefined"==typeof b)return a;for(c=0;c<a.length;c++)d=JSON.parse(JSON.stringify(a[c])),e.push(H.resolveTransformObject(d,b));return e}},I={$eq:function(a,b){return a===b},$aeq:function(a,b){return a==b},$ne:function(a,b){return b!==b?a===a:a!==b},$dteq:function(c,d){return a(c,d,!1)?!1:!b(c,d,!1)},$gt:function(a,c){return b(a,c,!1)},$gte:function(a,c){return b(a,c,!0)},$lt:function(b,c){return a(b,c,!1)},$lte:function(b,c){return a(b,c,!0)},$between:function(c,d){return void 0===c||null===c?!1:b(c,d[0],!0)&&a(c,d[1],!0)},$in:function(a,b){return-1!==b.indexOf(a)},$nin:function(a,b){return-1===b.indexOf(a)},$keyin:function(a,b){return a in b},$nkeyin:function(a,b){return!(a in b)},$definedin:function(a,b){return void 0!==b[a]},$undefinedin:function(a,b){return void 0===b[a]},$regex:function(a,b){return b.test(a)},$containsString:function(a,b){return"string"==typeof a&&-1!==a.indexOf(b)},$containsNone:function(a,b){return!I.$containsAny(a,b)},$containsAny:function(a,b){var c=f(a);return null!==c?Array.isArray(b)?b.some(c):c(b):!1},$contains:function(a,b){var c=f(a);return null!==c?Array.isArray(b)?b.every(c):c(b):!1},$type:function(a,b){var c=typeof a;return"object"===c&&(Array.isArray(a)?c="array":a instanceof Date&&(c="date")),"object"!=typeof b?c===b:g(c,b)},$size:function(a,b){return Array.isArray(a)?"object"!=typeof b?a.length===b:g(a.length,b):!1},$len:function(a,b){return"string"==typeof a?"object"!=typeof b?a.length===b:g(a.length,b):!1},$where:function(a,b){return b(a)===!0},$not:function(a,b){return!g(a,b)},$and:function(a,b){for(var c=0,d=b.length;d>c;c+=1)if(!g(a,b[c]))return!1;return!0},$or:function(a,b){for(var c=0,d=b.length;d>c;c+=1)if(g(a,b[c]))return!0;return!1}},J=["$eq","$aeq","$dteq","$gt","$gte","$lt","$lte","$in","$between"];return k.prototype.events={},k.prototype.asyncListeners=!1,k.prototype.on=function(a,b){var c,d=this;return Array.isArray(a)?(a.forEach(function(a){d.on(a,b)}),b):(c=this.events[a],c||(c=this.events[a]=[]),c.push(b),b)},k.prototype.emit=function(a,b){var c=this;if(!a||!this.events[a])throw new Error("No event "+a+" defined");this.events[a].forEach(function(a){c.asyncListeners?setTimeout(function(){a(b)},1):a(b)})},k.prototype.addListener=k.prototype.on,k.prototype.removeListener=function(a,b){var c=this;if(Array.isArray(a))return void a.forEach(function(a){c.removeListener(a,b)});if(this.events[a]){var d=this.events[a];d.splice(d.indexOf(b),1)}},l.prototype=new k,l.prototype.constructor=l,l.prototype.getIndexedAdapter=function(){var a;return"function"==typeof require&&(a=require("./loki-indexed-adapter.js")),a},l.prototype.configureOptions=function(a,b){var c={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage"},d={fs:o,localStorage:p};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,"undefined"!=typeof a){if(this.options=a,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof d[a.persistenceMethod]&&(this.persistenceMethod=a.persistenceMethod,this.persistenceAdapter=new d[a.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=a.adapter,this.options.adapter=null),a.autoload&&b){var e=this;setTimeout(function(){e.loadDatabase(a,a.autoloadCallback)},1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.options.hasOwnProperty("autosaveCallback")?this.autosaveEnable(a,a.autosaveCallback):this.autosaveEnable()),this.options.hasOwnProperty("throttledSaves")&&(this.throttledSaves=this.options.throttledSaves)}this.options.hasOwnProperty("serializationMethod")||(this.options.serializationMethod="normal"),this.options.hasOwnProperty("destructureDelimiter")||(this.options.destructureDelimiter="$<\n"),null===this.persistenceAdapter&&(this.persistenceMethod=c[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new d[this.persistenceMethod]))},l.prototype.copy=function(a){var b,c,d=new l(this.filename);if(a=a||{},d.loadJSONObject(this,{retainDirtyFlags:!0}),a.hasOwnProperty("removeNonSerializable")&&a.removeNonSerializable===!0)for(d.autosaveHandle=null,d.persistenceAdapter=null,b=d.collections.length,c=0;b>c;c++)d.collections[c].constraints=null,d.collections[c].ttl=null;return d},l.prototype.anonym=function(a,b){var c=new s("anonym",b);return c.insert(a),this.verbose&&(c.console=console),c},l.prototype.addCollection=function(a,b){var c=new s(a,b);return this.collections.push(c),this.verbose&&(c.console=console),c},l.prototype.loadCollection=function(a){if(!a.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(a)},l.prototype.getCollection=function(a){var b,c=this.collections.length;for(b=0;c>b;b+=1)if(this.collections[b].name===a)return this.collections[b];return this.emit("warning","collection "+a+" not found"),null},l.prototype.listCollections=function(){for(var a=this.collections.length,b=[];a--;)b.push({name:this.collections[a].name,type:this.collections[a].objType,count:this.collections[a].data.length});return b},l.prototype.removeCollection=function(a){var b,c=this.collections.length;for(b=0;c>b;b+=1)if(this.collections[b].name===a){var d=new s(a,{}),e=this.collections[b];for(var f in e)e.hasOwnProperty(f)&&d.hasOwnProperty(f)&&(e[f]=d[f]);return void this.collections.splice(b,1)}},l.prototype.getName=function(){return this.name},l.prototype.serializeReplacer=function(a,b){switch(a){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;case"throttledSavePending":case"throttledCallbacks":return void 0;default:return b}},l.prototype.serialize=function(a){switch(a=a||{},a.hasOwnProperty("serializationMethod")||(a.serializationMethod=this.options.serializationMethod),a.serializationMethod){case"normal":return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}},l.prototype.toJson=l.prototype.serialize,l.prototype.serializeDestructured=function(a){var b,c,d,e,f,g=[];if(a=a||{},a.hasOwnProperty("partitioned")||(a.partitioned=!1),a.hasOwnProperty("delimited")||(a.delimited=!0),a.hasOwnProperty("delimiter")||(a.delimiter=this.options.destructureDelimiter),a.partitioned===!0&&a.hasOwnProperty("partition")&&a.partition>=0)return this.serializeCollection({delimited:a.delimited,delimiter:a.delimiter,collectionIndex:a.partition});for(f=new l(this.filename),f.loadJSONObject(this),b=0;b<f.collections.length;b++)f.collections[b].data=[];if(a.partitioned===!0&&-1===a.partition)return f.serialize({serializationMethod:"normal"});for(g.push(f.serialize({serializationMethod:"normal"})),f=null,b=0;b<this.collections.length;b++)if(d=this.serializeCollection({delimited:a.delimited,delimiter:a.delimiter,collectionIndex:b}),a.partitioned===!1&&a.delimited===!1){if(!Array.isArray(d))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(e=d.length,c=0;e>c;c++)g.push(d[c]),d[c]=null;g.push("")}else g.push(d);return a.partitioned?a.delimited?g:g:a.delimited?(g.push(""),g.join(a.delimiter)):(g.push(""),g)},l.prototype.serializeCollection=function(a){var b,c,d=[];if(a=a||{},a.hasOwnProperty("delimited")||(a.delimited=!0),!a.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");for(b=this.collections[a.collectionIndex].data.length,d=[],c=0;b>c;c++)d.push(JSON.stringify(this.collections[a.collectionIndex].data[c]));return a.delimited?(d.push(""),d.join(a.delimiter)):d},l.prototype.deserializeDestructured=function(a,b){var c,d,e,f,g,h=[],i=0,j=1,k=!1;if(b=b||{},b.hasOwnProperty("partitioned")||(b.partitioned=!1),b.hasOwnProperty("delimited")||(b.delimited=!0),b.hasOwnProperty("delimiter")||(b.delimiter=this.options.destructureDelimiter),b.partitioned){if(b.hasOwnProperty("partition"))return-1===b.partition?d=JSON.parse(a[0]):this.deserializeCollection(a[b.partition+1],b);for(d=JSON.parse(a[0]),e=d.collections.length,i=0;e>i;i++)d.collections[i].data=this.deserializeCollection(a[i+1],b);return d}if(b.delimited){if(h=a.split(b.delimiter),a=null,c=h.length,0===c)return null}else h=a;for(d=JSON.parse(h[0]),e=d.collections.length,h[0]=null;!k;)f=h[j],""===h[j]?++i>e&&(k=!0):(g=JSON.parse(h[j]),d.collections[i].data.push(g)),h[j++]=null;return d},l.prototype.deserializeCollection=function(a,b){var c,d,e=[];for(b=b||{},b.hasOwnProperty("partitioned")||(b.partitioned=!1),b.hasOwnProperty("delimited")||(b.delimited=!0),b.hasOwnProperty("delimiter")||(b.delimiter=this.options.destructureDelimiter),b.delimited?(e=a.split(b.delimiter),e.pop()):e=a,d=e.length,c=0;d>c;c++)e[c]=JSON.parse(e[c]);return e},l.prototype.loadJSON=function(a,b){var c;if(0===a.length)c={};else switch(this.options.serializationMethod){case"normal":case"pretty":c=JSON.parse(a);break;case"destructured":c=this.deserializeDestructured(a);break;default:c=JSON.parse(a)}this.loadJSONObject(c,b)},l.prototype.loadJSONObject=function(a,b){function c(a){var c,d=b[a.name];return d.proto?(c=d.inflate||H.copyProperties,function(a){var b=new d.proto;return c(a,b),b}):d.inflate}var d,e,f,g,h,i,j=0,k=a.collections?a.collections.length:0;for(this.name=a.name,this.databaseVersion=1,a.hasOwnProperty("databaseVersion")&&(this.databaseVersion=a.databaseVersion),a.hasOwnProperty("throttledSaves")&&b&&!b.hasOwnProperty("throttledSaves")&&(this.throttledSaves=a.throttledSaves),this.collections=[],j;k>j;j+=1){if(d=a.collections[j],e=this.addCollection(d.name,{disableChangesApi:d.disableChangesApi}),e.adaptiveBinaryIndices=d.hasOwnProperty("adaptiveBinaryIndices")?d.adaptiveBinaryIndices===!0:!1,e.transactional=d.transactional,e.asyncListeners=d.asyncListeners,e.cloneObjects=d.cloneObjects,e.cloneMethod=d.cloneMethod||"parse-stringify",e.autoupdate=d.autoupdate,e.changes=d.changes,e.dirty=b&&b.retainDirtyFlags===!0?d.dirty:!1,f=d.data.length,g=0,b&&b.hasOwnProperty(d.name))for(h=c(d),g;f>g;g++)i=h(d.data[g]),e.data[g]=i,e.addAutoUpdateObserver(i);else for(g;f>g;g++)e.data[g]=d.data[g],e.addAutoUpdateObserver(e.data[g]);if(e.maxId="undefined"==typeof d.maxId?0:d.maxId,e.idIndex=d.idIndex,"undefined"!=typeof d.binaryIndices&&(e.binaryIndices=d.binaryIndices),"undefined"!=typeof d.transforms&&(e.transforms=d.transforms),e.ensureId(),e.uniqueNames=[],d.hasOwnProperty("uniqueNames"))for(e.uniqueNames=d.uniqueNames,g=0;g<e.uniqueNames.length;g++)e.ensureUniqueIndex(e.uniqueNames[g]);if("undefined"!=typeof d.DynamicViews)for(var l=0;l<d.DynamicViews.length;l++){var m=d.DynamicViews[l],n=e.addDynamicView(m.name,m.options);n.resultdata=m.resultdata,n.resultsdirty=m.resultsdirty,n.filterPipeline=m.filterPipeline,n.sortCriteria=m.sortCriteria,n.sortFunction=null,n.sortDirty=m.sortDirty,n.resultset.filteredrows=m.resultset.filteredrows,n.resultset.searchIsChained=m.resultset.searchIsChained,n.resultset.filterInitialized=m.resultset.filterInitialized,n.rematerialize({removeWhereFilters:!0})}}},l.prototype.close=function(a){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(a),a=void 0)),a&&this.on("close",a),this.emit("close")},l.prototype.generateChangesNotification=function(a){function b(a){return a.name}var c=[],d=a||this.collections.map(b);return this.collections.forEach(function(a){-1!==d.indexOf(b(a))&&(c=c.concat(a.getChanges()))}),c},l.prototype.serializeChanges=function(a){return JSON.stringify(this.generateChangesNotification(a))},l.prototype.clearChanges=function(){this.collections.forEach(function(a){a.flushChanges&&a.flushChanges()})},m.prototype.loadDatabase=function(a,b){var c=this;this.options.asyncResponses?setTimeout(function(){b(c.hashStore.hasOwnProperty(a)?c.hashStore[a].value:new Error("unable to load database, "+a+" was not found in memory adapter"))},this.options.asyncTimeout):b(this.hashStore.hasOwnProperty(a)?this.hashStore[a].value:new Error("unable to load database, "+a+" was not found in memory adapter"))},m.prototype.saveDatabase=function(a,b,c){var d,e=this;this.options.asyncResponses?setTimeout(function(){d=e.hashStore.hasOwnProperty(a)?e.hashStore[a].savecount:0,e.hashStore[a]={savecount:d+1,lastsave:new Date,value:b},c()},this.options.asyncTimeout):(d=this.hashStore.hasOwnProperty(a)?this.hashStore[a].savecount:0,this.hashStore[a]={savecount:d+1,lastsave:new Date,value:b},c())},m.prototype.deleteDatabase=function(a,b){this.hashStore.hasOwnProperty(a)&&delete this.hashStore[a],"function"==typeof b&&b()},n.prototype.loadDatabase=function(a,b){var c=this;this.dbname=a,this.dbref=new l(a),this.adapter.loadDatabase(a,function(a){"string"!=typeof a&&b(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()"));var d=JSON.parse(a);c.dbref.loadJSONObject(d),d=null;c.dbref.collections.length;return 0===c.dbref.collections.length?void b(c.dbref):(c.pageIterator={collection:0,pageIndex:0},void c.loadNextPartition(0,function(){b(c.dbref)}))})},n.prototype.loadNextPartition=function(a,b){var c=this.dbname+"."+a,d=this;return this.options.paging===!0?(this.pageIterator.pageIndex=0,void this.loadNextPage(b)):void this.adapter.loadDatabase(c,function(c){var e=d.dbref.deserializeCollection(c,{delimited:!0,collectionIndex:a});d.dbref.collections[a].data=e,++a<d.dbref.collections.length?d.loadNextPartition(a,b):b()})},n.prototype.loadNextPage=function(a){var b=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,c=this;this.adapter.loadDatabase(b,function(b){var d=b.split(c.options.delimiter);b="";var e,f=d.length,g=""===d[f-1];for(g&&(d.pop(),f=d.length,""===d[f-1]&&1===f&&(d.pop(),f=d.length)),e=0;f>e;e++)c.dbref.collections[c.pageIterator.collection].data.push(JSON.parse(d[e])),d[e]=null;d=[],g?++c.pageIterator.collection<c.dbref.collections.length?c.loadNextPartition(c.pageIterator.collection,a):a():(c.pageIterator.pageIndex++,c.loadNextPage(a))})},n.prototype.exportDatabase=function(a,b,c){var d,e=b.collections.length;for(this.dbref=b,this.dbname=a,this.dirtyPartitions=[-1],d=0;e>d;d++)b.collections[d].dirty&&this.dirtyPartitions.push(d);this.saveNextPartition(function(a){c(a)})},n.prototype.saveNextPartition=function(a){var b=this,c=this.dirtyPartitions.shift(),d=this.dbname+(-1===c?"":"."+c);if(this.options.paging&&-1!==c)return this.pageIterator={collection:c,docIndex:0,pageIndex:0},void this.saveNextPage(function(c){0===b.dirtyPartitions.length?a(c):b.saveNextPartition(a)});var e=this.dbref.serializeDestructured({partitioned:!0,delimited:!0,partition:c});this.adapter.saveDatabase(d,e,function(c){return c?void a(c):void(0===b.dirtyPartitions.length?a(null):b.saveNextPartition(a))})},n.prototype.saveNextPage=function(a){var b=this,c=this.dbref.collections[this.pageIterator.collection],d=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,e=0,f=c.data.length,g=this.options.delimiter.length,h="",i="",j=!1,k=!1,l=function(c){i="",c&&a(c),j?a(null):(b.pageIterator.pageIndex++,b.saveNextPage(a))};for(0===c.data.length&&(j=!0);;)if(j||(h=JSON.stringify(c.data[this.pageIterator.docIndex]),i+=h,e+=h.length,++this.pageIterator.docIndex>=f&&(j=!0)),e>=this.options.pageSize&&(k=!0),(!k||j)&&(i+=this.options.delimiter,e+=g),j||k)return void this.adapter.saveDatabase(d,i,l)},o.prototype.loadDatabase=function(a,b){var c=this;this.fs.stat(a,function(d,e){!d&&e.isFile()?c.fs.readFile(a,{encoding:"utf8"},function(a,c){b(a?new Error(a):c)}):b(null)})},o.prototype.saveDatabase=function(a,b,c){var d=this,e=a+"~";this.fs.writeFile(e,b,function(b){b?c(new Error(b)):d.fs.rename(e,a,c)})},o.prototype.deleteDatabase=function(a,b){this.fs.unlink(a,function(a){a?b(new Error(a)):b()})},p.prototype.loadDatabase=function(a,b){b(j()?localStorage.getItem(a):new Error("localStorage is not available"))},p.prototype.saveDatabase=function(a,b,c){j()?(localStorage.setItem(a,b),c(null)):c(new Error("localStorage is not available"))},p.prototype.deleteDatabase=function(a,b){j()?(localStorage.removeItem(a),b(null)):b(new Error("localStorage is not available"))},l.prototype.throttledSaveDrain=function(a,b){var c=this,d=(new Date).getTime();if(this.throttledSaves||a(!0),b=b||{},b.hasOwnProperty("recursiveWait")||(b.recursiveWait=!0),b.hasOwnProperty("recursiveWaitLimit")||(b.recursiveWaitLimit=!1),b.hasOwnProperty("recursiveWaitLimitDuration")||(b.recursiveWaitLimitDuration=2e3),b.hasOwnProperty("started")||(b.started=(new Date).getTime()),this.throttledSaves&&this.throttledSavePending){if(!b.recursiveWait)return void this.throttledCallbacks.push(a);this.throttledCallbacks.push(function(){return c.throttledSavePending?b.recursiveWaitLimit&&d-b.started>b.recursiveWaitLimitDuration?void a(!1):void c.throttledSaveDrain(a,b):void a(!0)})}else a(!0)},l.prototype.loadDatabaseInternal=function(a,b){var c=b||function(a){if(a)throw a},d=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,function(b){if("string"==typeof b){var e=!1;try{d.loadJSON(b,a||{}),e=!0}catch(f){c(f)}e&&(c(null),d.emit("loaded","database "+d.filename+" loaded"))}else"object"!=typeof b||null===b||b instanceof Error?c(b):(d.loadJSONObject(b,a||{}),c(null),d.emit("loaded","database "+d.filename+" loaded"))}):c(new Error("persistenceAdapter not configured"))},l.prototype.loadDatabase=function(a,b){var c=this;return this.throttledSaves?void this.throttledSaveDrain(function(d){return d?(c.throttledSavePending=!0,void c.loadDatabaseInternal(a,function(a){0===c.throttledCallbacks.length?c.throttledSavePending=!1:c.saveDatabase(),"function"==typeof b&&b(a)})):void("function"==typeof b&&b(new Error("Unable to pause save throttling long enough to read database")))},a):void this.loadDatabaseInternal(a,b)},l.prototype.saveDatabaseInternal=function(a){var b=a||function(a){if(a)throw a},c=this;null!==this.persistenceAdapter?"reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0}),function(a){c.autosaveClearFlags(),b(a)}):this.persistenceAdapter.saveDatabase(this.filename,c.serialize(),function(a){c.autosaveClearFlags(),b(a)}):b(new Error("persistenceAdapter not configured"))},l.prototype.saveDatabase=function(a){if(!this.throttledSaves)return void this.saveDatabaseInternal(a);if(this.throttledSavePending)return void this.throttledCallbacks.push(a);var b=this.throttledCallbacks;this.throttledCallbacks=[],b.unshift(a),this.throttledSavePending=!0;var c=this;this.saveDatabaseInternal(function(a){c.throttledSavePending=!1,b.forEach(function(b){"function"==typeof b&&setTimeout(function(){b(a)},1)}),c.throttledCallbacks.length>0&&c.saveDatabase()})},l.prototype.save=l.prototype.saveDatabase,l.prototype.deleteDatabase=function(a,b){var c=b||function(a){if(a)throw a};null!==this.persistenceAdapter?this.persistenceAdapter.deleteDatabase(this.filename,function(a){c(a)}):c(new Error("persistenceAdapter not configured"))},l.prototype.autosaveDirty=function(){for(var a=0;a<this.collections.length;a++)if(this.collections[a].dirty)return!0;return!1},l.prototype.autosaveClearFlags=function(){for(var a=0;a<this.collections.length;a++)this.collections[a].dirty=!1},l.prototype.autosaveEnable=function(a,b){this.autosave=!0;var c=5e3,d=this;"undefined"!=typeof this.autosaveInterval&&null!==this.autosaveInterval&&(c=this.autosaveInterval),this.autosaveHandle=setInterval(function(){d.autosaveDirty()&&d.saveDatabase(b)},c)},l.prototype.autosaveDisable=function(){"undefined"!=typeof this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},q.prototype.reset=function(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this},q.prototype.toJSON=function(){var a=this.copy();return a.collection=null,a},q.prototype.limit=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var b=new q(this.collection);return b.filteredrows=this.filteredrows.slice(0,a),b.filterInitialized=!0,b},q.prototype.offset=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var b=new q(this.collection);return b.filteredrows=this.filteredrows.slice(a),b.filterInitialized=!0,b},q.prototype.copy=function(){var a=new q(this.collection);return this.filteredrows.length>0&&(a.filteredrows=this.filteredrows.slice()),a.filterInitialized=this.filterInitialized,a},q.prototype.branch=q.prototype.copy,q.prototype.transform=function(a,b){var c,d,e=this;if("string"==typeof a&&this.collection.transforms.hasOwnProperty(a)&&(a=this.collection.transforms[a]),"object"!=typeof a||!Array.isArray(a))throw new Error("Invalid transform");for("undefined"!=typeof b&&(a=H.resolveTransformParams(a,b)),c=0;c<a.length;c++)switch(d=a[c],d.type){case"find":e.find(d.value);break;case"where":e.where(d.value);break;case"simplesort":e.simplesort(d.property,d.desc);break;case"compoundsort":e.compoundsort(d.value);break;case"sort":e.sort(d.value);break;case"limit":e=e.limit(d.value);break;case"offset":e=e.offset(d.value);break;case"map":e=e.map(d.value);break;case"eqJoin":e=e.eqJoin(d.joinData,d.leftJoinKey,d.rightJoinKey,d.mapFun);break;case"mapReduce":e=e.mapReduce(d.mapFunction,d.reduceFunction);break;case"update":e.update(d.value);break;case"remove":e.remove()}return e},q.prototype.instance=function(a){var b,c,d=this.data();a=a||{};var e=new s(a);for(b=0;b<d.length;b++)c=this.collection.cloneObjects?d[b]:h(d[b],this.collection.cloneMethod),delete c.$loki,delete c.meta,e.insert(c);return e},q.prototype.sort=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var b=function(a,b){return function(c,d){return a(b[c],b[d])}}(a,this.collection.data);return this.filteredrows.sort(b),this},q.prototype.simplesort=function(a,b){if(this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length){if(this.collection.binaryIndices.hasOwnProperty(a))return this.collection.ensureIndex(a),this.filteredrows=this.collection.binaryIndices[a].values.slice(0),this;this.filteredrows=this.collection.prepareFullDocIndex()}"undefined"==typeof b&&(b=!1);var d=function(a,b,d){return function(e,f){return c(d[e][a],d[f][a],b)}}(a,b,this.collection.data);return this.filteredrows.sort(d),this},q.prototype.compoundsort=function(a){if(0===a.length)throw new Error("Invalid call to compoundsort, need at least one property");var b;if(1===a.length)return b=a[0],Array.isArray(b)?this.simplesort(b[0],b[1]):this.simplesort(b,!1);for(var c=0,e=a.length;e>c;c+=1)b=a[c],Array.isArray(b)||(a[c]=[b,!1]);this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var f=function(a,b){return function(c,e){return d(a,b[c],b[e])}}(a,this.collection.data);return this.filteredrows.sort(f),this},q.prototype.findOr=function(a){for(var b=null,c=0,d=0,e=[],f=[],g=0,h=this.count(),i=0,j=a.length;j>i;i++){if(b=this.branch().find(a[i]).filteredrows,
d=b.length,d===h)return this;for(c=0;d>c;c++)g=b[c],void 0===f[g]&&(f[g]=!0,e.push(g))}return this.filteredrows=e,this.filterInitialized=!0,this},q.prototype.$or=q.prototype.findOr,q.prototype.findAnd=function(a){for(var b=0,c=a.length;c>b;b++){if(0===this.count())return this;this.find(a[b])}return this},q.prototype.$and=q.prototype.findAnd,q.prototype.find=function(a,b){if(0===this.collection.data.length)return this.searchIsChained?(this.filteredrows=[],this.filterInitialized=!0,this):[];var c,d,f,g,h,i,j=a||"getAll",k=!1,l=[],m=null;if(b=b||!1,"object"==typeof j)for(c in j)if(G.call(j,c)){d=c,f=j[c];break}if(!d||"getAll"===j)return b?this.collection.data.length>0?this.collection.data[0]:null:this.searchIsChained?this:this.collection.data.slice();if("$and"===d||"$or"===d)return this.searchIsChained?(this[d](f),b&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(l=this.collection.chain()[d](f).data(),b?0===l.length?[]:l[0]:l);if(null===f||"object"!=typeof f||f instanceof Date)g="$eq",h=f;else{if("object"!=typeof f)throw new Error("Do not know what you want to do.");for(i in f)if(G.call(f,i)){g=i,h=f[i];break}}"$regex"===g&&(Array.isArray(h)?h=new RegExp(h[0],h[1]):h instanceof RegExp||(h=new RegExp(h)));var n=-1!==d.indexOf("."),o=!(n||this.searchIsChained&&this.filterInitialized);o&&this.collection.binaryIndices[d]&&-1!==J.indexOf(g)&&(this.collection.adaptiveBinaryIndices!==!0&&this.collection.ensureIndex(d),k=!0,m=this.collection.binaryIndices[d]);var p=I[g],q=this.collection.data,r=0,s=0;if(!this.searchIsChained){if(k){var t=this.collection.calculateRange(g,d,h);if(b)return-1!==t[1]?q[m.values[t[0]]]:[];if("$in"!==g)for(r=t[0];r<=t[1];r++)l.push(q[m.values[r]]);else for(r=0,s=t.length;s>r;r++)l.push(q[m.values[t[r]]])}else{if(r=q.length,b){if(n){for(d=d.split(".");r--;)if(e(q[r],d,p,h))return q[r]}else for(;r--;)if(p(q[r][d],h))return q[r];return[]}if(n)for(d=d.split(".");r--;)e(q[r],d,p,h)&&l.push(q[r]);else for(;r--;)p(q[r][d],h)&&l.push(q[r])}return l}var u,v=0;if(this.filterInitialized)if(u=this.filteredrows,s=u.length,n)for(d=d.split("."),r=0;s>r;r++)v=u[r],e(q[v],d,p,h)&&l.push(v);else for(r=0;s>r;r++)v=u[r],p(q[v][d],h)&&l.push(v);else{if(k){var w=this.collection.calculateRange(g,d,h);if("$in"!==g)for(r=w[0];r<=w[1];r++)l.push(m.values[r]);else for(r=0,s=w.length;s>r;r++)l.push(m.values[w[r]])}else if(s=q.length,n)for(d=d.split("."),r=0;s>r;r++)e(q[r],d,p,h)&&l.push(r);else for(r=0;s>r;r++)p(q[r][d],h)&&l.push(r);this.filterInitialized=!0}return this.filteredrows=l,this},q.prototype.where=function(a){var b,c=[];if("function"!=typeof a)throw new TypeError("Argument is not a stored view or a function");b=a;try{if(this.searchIsChained){if(this.filterInitialized){for(var d=this.filteredrows.length;d--;)b(this.collection.data[this.filteredrows[d]])===!0&&c.push(this.filteredrows[d]);return this.filteredrows=c,this}for(var e=this.collection.data.length;e--;)b(this.collection.data[e])===!0&&c.push(e);return this.filteredrows=c,this.filterInitialized=!0,this}for(var f=this.collection.data.length;f--;)b(this.collection.data[f])===!0&&c.push(this.collection.data[f]);return c}catch(g){throw g}},q.prototype.count=function(){return this.searchIsChained&&this.filterInitialized?this.filteredrows.length:this.collection.count()},q.prototype.data=function(a){var b,c,d,e=[],f=this.collection.data;if(a=a||{},this.searchIsChained&&!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||a.forceClones){for(b=f.length,d=a.forceCloneMethod||this.collection.cloneMethod,c=0;b>c;c++)e.push(h(f[c],d));return e}return f.slice()}this.filterInitialized=!0}var g=this.filteredrows;if(b=g.length,this.collection.cloneObjects||a.forceClones)for(d=a.forceCloneMethod||this.collection.cloneMethod,c=0;b>c;c++)e.push(h(f[g[c]],d));else for(c=0;b>c;c++)e.push(f[g[c]]);return e},q.prototype.update=function(a){if("function"!=typeof a)throw new TypeError("Argument is not a function");this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());for(var b=this.filteredrows.length,c=this.collection.data,d=0;b>d;d++)a(c[this.filteredrows[d]]),this.collection.update(c[this.filteredrows[d]]);return this},q.prototype.remove=function(){return this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.remove(this.data()),this.filteredrows=[],this},q.prototype.mapReduce=function(a,b){try{return b(this.data().map(a))}catch(c){throw c}},q.prototype.eqJoin=function(a,b,c,d){var e,f,g,h=[],i=[],j=[],k="function"==typeof b,l="function"==typeof c,m={};if(h=this.data(),e=h.length,a instanceof q)i=a.data();else{if(!Array.isArray(a))throw new TypeError("joinData needs to be an array or result set");i=a}f=i.length;for(var n=0;f>n;n++)g=l?c(i[n]):i[n][c],m[g]=i[n];d||(d=function(a,b){return{left:a,right:b}});for(var o=0;e>o;o++)g=k?b(h[o]):h[o][b],j.push(d(h[o],m[g]||{}));return this.collection=new s("joinData"),this.collection.insert(j),this.filteredrows=[],this.filterInitialized=!1,this},q.prototype.map=function(a){var b=this.data().map(a);return this.collection=new s("mappedData"),this.collection.insert(b),this.filteredrows=[],this.filterInitialized=!1,this},r.prototype=new k,r.prototype.rematerialize=function(a){var b,c,d;if(a=a||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new q(this.collection),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0),a.hasOwnProperty("removeWhereFilters"))for(b=this.filterPipeline.length,c=b;c--;)"where"===this.filterPipeline[c].type&&(c!==this.filterPipeline.length-1&&(this.filterPipeline[c]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var e=this.filterPipeline;for(this.filterPipeline=[],b=e.length,d=0;b>d;d++)this.applyFind(e[d].val);return this.data(),this.emit("rebuild",this),this},r.prototype.branchResultset=function(a,b){var c=this.resultset.branch();return"undefined"==typeof a?c:c.transform(a,b)},r.prototype.toJSON=function(){var a=new r(this.collection,this.name,this.options);return a.resultset=this.resultset,a.resultdata=[],a.resultsdirty=!0,a.filterPipeline=this.filterPipeline,a.sortFunction=this.sortFunction,a.sortCriteria=this.sortCriteria,a.sortDirty=this.sortDirty,a.collection=null,a},r.prototype.removeFilters=function(a){a=a||{},this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,a.queueSortPhase===!0&&this.queueSortPhase()},r.prototype.applySort=function(a){return this.sortFunction=a,this.sortCriteria=null,this.queueSortPhase(),this},r.prototype.applySimpleSort=function(a,b){return this.sortCriteria=[[a,b||!1]],this.sortFunction=null,this.queueSortPhase(),this},r.prototype.applySortCriteria=function(a){return this.sortCriteria=a,this.sortFunction=null,this.queueSortPhase(),this},r.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},r.prototype.commit=function(){return this.cachedresultset=null,this},r.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},r.prototype._indexOfFilterWithId=function(a){if("string"==typeof a||"number"==typeof a)for(var b=0,c=this.filterPipeline.length;c>b;b+=1)if(a===this.filterPipeline[b].uid)return b;return-1},r.prototype._addFilter=function(a){this.filterPipeline.push(a),this.resultset[a.type](a.val)},r.prototype.reapplyFilters=function(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var a=this.filterPipeline;this.filterPipeline=[];for(var b=0,c=a.length;c>b;b+=1)this._addFilter(a[b]);return this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this},r.prototype.applyFilter=function(a){var b=this._indexOfFilterWithId(a.uid);return b>=0?(this.filterPipeline[b]=a,this.reapplyFilters()):(this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(a),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this)},r.prototype.applyFind=function(a,b){return this.applyFilter({type:"find",val:a,uid:b}),this},r.prototype.applyWhere=function(a,b){return this.applyFilter({type:"where",val:a,uid:b}),this},r.prototype.removeFilter=function(a){var b=this._indexOfFilterWithId(a);if(0>b)throw new Error("Dynamic view does not contain a filter with ID: "+a);return this.filterPipeline.splice(b,1),this.reapplyFilters(),this},r.prototype.count=function(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()},r.prototype.data=function(){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data()},r.prototype.queueRebuildEvent=function(){if(!this.rebuildPending){this.rebuildPending=!0;var a=this;setTimeout(function(){a.rebuildPending&&(a.rebuildPending=!1,a.emit("rebuild",a))},this.options.minRebuildInterval)}},r.prototype.queueSortPhase=function(){if(!this.sortDirty){this.sortDirty=!0;var a=this;"active"===this.options.sortPriority?setTimeout(function(){a.performSortPhase()},this.options.minRebuildInterval):this.queueRebuildEvent()}},r.prototype.performSortPhase=function(a){(this.sortDirty||this.resultsdirty)&&(a=a||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria&&this.resultset.compoundsort(this.sortCriteria),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),a.suppressRebuildEvent||this.emit("rebuild",this))},r.prototype.evaluateDocument=function(a,b){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent());var c=this.resultset.filteredrows,d=b?-1:c.indexOf(+a),e=c.length,f=new q(this.collection);f.filteredrows=[a],f.filterInitialized=!0;for(var g,h=0,i=this.filterPipeline.length;i>h;h++)g=this.filterPipeline[h],f[g.type](g.val);var j=0===f.filteredrows.length?-1:0;return-1!==d||-1!==j?-1===d&&-1!==j?(c.push(a),this.options.persistent&&this.resultdata.push(this.collection.data[a]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):-1!==d&&-1===j?(e-1>d?(c.splice(d,1),this.options.persistent&&this.resultdata.splice(d,1)):(c.length=e-1,this.options.persistent&&(this.resultdata.length=e-1)),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):-1!==d&&-1!==j?(this.options.persistent&&(this.resultdata[d]=this.collection.data[a]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0},r.prototype.removeDocument=function(a){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent());var b,c=this.resultset.filteredrows,d=c.indexOf(+a),e=c.length;for(-1!==d&&(e-1>d?(c[d]=c[e-1],c.length=e-1,this.options.persistent&&(this.resultdata[d]=this.resultdata[e-1],this.resultdata.length=e-1)):(c.length=e-1,this.options.persistent&&(this.resultdata.length=e-1)),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent()),e=c.length,b=0;e>b;b++)c[b]>a&&c[b]--},r.prototype.mapReduce=function(a,b){try{return b(this.data().map(a))}catch(c){throw c}},s.prototype=new k,s.prototype.console={log:function(){},warn:function(){},error:function(){}},s.prototype.addAutoUpdateObserver=function(a){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(a,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])},s.prototype.removeAutoUpdateObserver=function(a){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(a,this.observerCallback)},s.prototype.addTransform=function(a,b){if(this.transforms.hasOwnProperty(a))throw new Error("a transform by that name already exists");this.transforms[a]=b},s.prototype.setTransform=function(a,b){this.transforms[a]=b},s.prototype.removeTransform=function(a){delete this.transforms[a]},s.prototype.byExample=function(a){var b,c,d;d=[];for(b in a)a.hasOwnProperty(b)&&d.push((c={},c[b]=a[b],c));return{$and:d}},s.prototype.findObject=function(a){return this.findOne(this.byExample(a))},s.prototype.findObjects=function(a){return this.find(this.byExample(a))},s.prototype.ttlDaemonFuncGen=function(){var a=this,b=this.ttl.age;return function(){var c=Date.now(),d=a.chain().where(function(a){var d=a.meta.updated||a.meta.created,e=c-d;return e>b});d.remove()}},s.prototype.setTTL=function(a,b){0>a?clearInterval(this.ttl.daemon):(this.ttl.age=a,this.ttl.ttlInterval=b,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),b))},s.prototype.prepareFullDocIndex=function(){for(var a=this.data.length,b=new Array(a),c=0;a>c;c+=1)b[c]=c;return b},s.prototype.configureOptions=function(a){a=a||{},a.hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=a.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())},s.prototype.ensureIndex=function(c,d){if("undefined"==typeof d&&(d=!1),null===c||void 0===c)throw new Error("Attempting to set index without an associated property");if((!this.binaryIndices[c]||d||this.binaryIndices[c].dirty)&&(this.adaptiveBinaryIndices!==!0||!this.binaryIndices.hasOwnProperty(c)||d)){var e={name:c,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[c]=e;var f=function(c,d){return function(e,f){var g=d[e][c],h=d[f][c];if(g!==h){if(a(g,h,!1))return-1;if(b(g,h,!1))return 1}return 0}}(c,this.data);e.values.sort(f),e.dirty=!1,this.dirty=!0}},s.prototype.getSequencedIndexValues=function(a){var b,c=this.binaryIndices[a].values,d="";for(b=0;b<c.length;b++)d+=" ["+b+"] "+this.data[c[b]][a];return d},s.prototype.ensureUniqueIndex=function(a){var b=this.constraints.unique[a];return b||-1==this.uniqueNames.indexOf(a)&&this.uniqueNames.push(a),this.constraints.unique[a]=b=new D(a),this.data.forEach(function(a){b.set(a)}),b},s.prototype.ensureAllIndexes=function(a){var b,c=this.binaryIndices;for(b in c)G.call(c,b)&&this.ensureIndex(b,a)},s.prototype.flagBinaryIndexesDirty=function(){var a,b=this.binaryIndices;for(a in b)G.call(b,a)&&(b[a].dirty=!0)},s.prototype.flagBinaryIndexDirty=function(a){this.binaryIndices[a]&&(this.binaryIndices[a].dirty=!0)},s.prototype.count=function(a){return a?this.chain().find(a).filteredrows.length:this.data.length},s.prototype.ensureId=function(){var a=this.data.length,b=0;for(this.idIndex=[],b;a>b;b+=1)this.idIndex.push(this.data[b].$loki)},s.prototype.ensureIdAsync=function(a){this.async(function(){this.ensureId()},a)},s.prototype.addDynamicView=function(a,b){var c=new r(this,a,b);return this.DynamicViews.push(c),c},s.prototype.removeDynamicView=function(a){for(var b=0;b<this.DynamicViews.length;b++)this.DynamicViews[b].name===a&&this.DynamicViews.splice(b,1)},s.prototype.getDynamicView=function(a){for(var b=0;b<this.DynamicViews.length;b++)if(this.DynamicViews[b].name===a)return this.DynamicViews[b];return null},s.prototype.findAndUpdate=function(a,b){"function"==typeof a?this.updateWhere(a,b):this.chain().find(a).update(b)},s.prototype.findAndRemove=function(a){this.chain().find(a).remove()},s.prototype.insert=function(a){if(!Array.isArray(a))return this.insertOne(a);var b,c=[];this.emit("pre-insert",a);for(var d=0,e=a.length;e>d;d++){if(b=this.insertOne(a[d],!0),!b)return void 0;c.push(b)}return this.emit("insert",c),1===c.length?c[0]:c},s.prototype.insertOne=function(a,b){var c,d=null;if("object"!=typeof a?d=new TypeError("Document needs to be an object"):null===a&&(d=new TypeError("Object cannot be null")),null!==d)throw this.emit("error",d),d;var e=this.cloneObjects?h(a,this.cloneMethod):a;return"undefined"==typeof e.meta&&(e.meta={revision:0,created:0}),b||this.emit("pre-insert",e),this.add(e)?(c=this.cloneObjects?h(e,this.cloneMethod):e,this.addAutoUpdateObserver(c),b||this.emit("insert",c),c):void 0},s.prototype.clear=function(a){var b=this;if(a=a||{},this.data=[],this.idIndex=[],this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,a.removeIndices===!0)this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[];else{var c=Object.keys(this.binaryIndices);c.forEach(function(a){b.binaryIndices[a].dirty=!1,b.binaryIndices[a].values=[]}),this.constraints={unique:{},exact:{}},this.uniqueNames.forEach(function(a){b.ensureUniqueIndex(a)})}},s.prototype.update=function(a){if(Array.isArray(a)){var b=0,c=a.length;for(b;c>b;b+=1)this.update(a[b])}else{if(!G.call(a,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var d,e,f,g=this.get(a.$loki,!0),i=this;if(!g)throw new Error("Trying to update a document not in collection.");d=g[0],f=g[1],e=this.cloneObjects?h(a,this.cloneMethod):a,this.emit("pre-update",a),Object.keys(this.constraints.unique).forEach(function(a){i.constraints.unique[a].update(d,e)}),this.data[f]=e,e!==a&&this.addAutoUpdateObserver(a);for(var j=0;j<this.DynamicViews.length;j++)this.DynamicViews[j].evaluateDocument(f,!1);var k;if(this.adaptiveBinaryIndices){var l=this.binaryIndices;for(k in l)this.adaptiveBinaryIndexUpdate(f,k)}else this.flagBinaryIndexesDirty();return this.idIndex[f]=e.$loki,this.commit(),this.dirty=!0,this.emit("update",a,this.cloneObjects?h(d,this.cloneMethod):null),a}catch(m){throw this.rollback(),this.if("undefined"!=typeof a.$loki)throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1),a.$loki=this.maxId,a.meta.version=0;var b,c=this.constraints.unique;for(b in c)G.call(c,b)&&c[b].set(a);this.idIndex.push(a.$loki),this.data.push(a);for(var d=this.data.length-1,e=this.DynamicViews.length,f=0;e>f;f++)this.DynamicViews[f].evaluateDocument(d,!0);if(this.adaptiveBinaryIndices){var g=this.binaryIndices;for(b in g)this.adaptiveBinaryIndexInsert(d,b)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?h(a,this.cloneMethod):a}catch(i){throw this.rollback(),this.,e=0;try{for(e;e<d.length;e++)c=b(d[e]),this.update(c)}catch(f){this.rollback(),this.{var b;"function"==typeof a?(b=this.data.filter(a),this.remove(b)):this.chain().find(a).remove()},s.prototype.removeDataOnly=function(){this.remove(this.data.slice())},s.prototype.remove=function(a){if("number"==typeof a&&(a=this.get(a)),"object"!=typeof a)throw new Error("Parameter is not an object");if(Array.isArray(a)){var b=0,c=a.length;for(b;c>b;b+=1)this.remove(a[b])}else{if(!G.call(a,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();var d=this.get(a.$loki,!0),e=d[1],f=this;Object.keys(this.constraints.unique).forEach(function(b){null!==a[b]&&"undefined"!=typeof a[b]&&f.constraints.unique[b].remove(a[b])});for(var g=0;g<this.DynamicViews.length;g++)this.DynamicViews[g].removeDocument(e);if(this.adaptiveBinaryIndices){var h,i=this.binaryIndices;for(h in i)this.adaptiveBinaryIndexRemove(e,h)}else this.flagBinaryIndexesDirty();return this.data.splice(e,1),this.removeAutoUpdateObserver(a),this.idIndex.splice(e,1),this.commit(),this.dirty=!0,this.emit("delete",d[0]),delete a.$loki,delete a.meta,a}catch(j){return this.rollback(),this.{var c=b||!1,d=this.idIndex,e=d.length-1,f=0,g=f+e>>1;if(a="number"==typeof a?a:parseInt(a,10),isNaN(a))throw new TypeError("Passed id is not an integer");for(;d[f]<d[e];)g=f+e>>1,d[g]<a?f=g+1:e=g;return e===f&&d[f]===a?c?[this.data[f],f]:this.data[f]:null},s.prototype.getBinaryIndexPosition=function(a,b){var c=this.data[a][b],d=this.binaryIndices[b].values,e=this.calculateRange("$eq",b,c);if(0===e[0]&&-1===e[1])return null;for(var f=e[0],g=e[1],h=f;g>=h;h++)if(d[h]===a)return h;return null},s.prototype.adaptiveBinaryIndexInsert=function(a,b){var c=(this.binaryIndices[b].values,this.data[a][b]),d=this.calculateRangeStart(b,c);this.binaryIndices[b].values.splice(d,0,a)},s.prototype.adaptiveBinaryIndexUpdate=function(a,b){var c,d=this.binaryIndices[b].values,e=d.length;for(c=0;e>c&&d[c]!==a;c++);this.binaryIndices[b].values.splice(c,1),this.adaptiveBinaryIndexInsert(a,b)},s.prototype.adaptiveBinaryIndexRemove=function(a,b,c){var d,e,f=this.getBinaryIndexPosition(a,b),g=this.binaryIndices[b].values;if(null===f)return null;if(this.binaryIndices[b].values.splice(f,1),c!==!0)for(d=g.length,e=0;d>e;e++)g[e]>a&&g[e]--},s.prototype.calculateRangeStart=function(b,c){var d=this.data,e=this.binaryIndices[b].values,f=0,g=e.length-1,h=0;if(0===e.length)return 0;for(d[e[f]][b],d[e[g]][b];g>f;)h=f+g>>1,a(d[e[h]][b],c,!1)?f=h+1:g=h;var i=f;return a(d[e[i]][b],c,!1)?i+1:i},s.prototype.calculateRangeEnd=function(c,d){var e=this.data,f=this.binaryIndices[c].values,g=0,h=f.length-1,i=0;if(0===f.length)return 0;for(e[f[g]][c],e[f[h]][c];h>g;)i=g+h>>1,a(d,e[f[i]][c],!1)?h=i:g=i+1;var j=h;return b(e[f[j]][c],d,!1)?j-1:j},s.prototype.calculateRange=function(c,d,e){var f=this.data,g=this.binaryIndices[d].values,h=0,i=g.length-1,j=0;if(0===f.length)return[0,-1];var k=f[g[h]][d],l=f[g[i]][d];switch(c){case"$eq":case"$aeq":if(a(e,k,!1)||b(e,l,!1))return[0,-1];break;case"$dteq":if(a(e,k,!1)||b(e,l,!1))return[0,-1];break;case"$gt":if(b(e,l,!0))return[0,-1];break;case"$gte":if(b(e,l,!1))return[0,-1];break;case"$lt":if(a(e,k,!0))return[0,-1];if(a(l,e,!1))return[0,f.length-1];break;case"$lte":if(a(e,k,!1))return[0,-1];if(a(l,e,!0))return[0,f.length-1];break;case"$between":return[this.calculateRangeStart(d,e[0]),this.calculateRangeEnd(d,e[1])];case"$in":for(var m=[],n=[],o=0,p=e.length;p>o;o++)for(var q=this.calculateRange("$eq",d,e[o]),r=q[0];r<=q[1];r++)void 0===m[r]&&(m[r]=!0,n.push(r));return n}for(;i>h;)j=h+i>>1,a(f[g[j]][d],e,!1)?h=j+1:i=j;var s=h;for(i=g.length-1;i>h;)j=h+i>>1,a(e,f[g[j]][d],!1)?i=j:h=j+1;var t=i,u=f[g[s]][d],v=f[g[t]][d];switch(c){case"$eq":return u!==e?[0,-1]:(v!==e&&t--,[s,t]);case"$dteq":return u>e||e>u?[0,-1]:((v>e||e>v)&&t--,[s,t]);case"$gt":return a(v,e,!0)?[0,-1]:[t,f.length-1];case"$gte":return a(u,e,!1)?[0,-1]:[s,f.length-1];case"$lt":return 0===s&&a(u,e,!1)?[0,0]:[0,s-1];case"$lte":return v!==e&&t--,0===t&&a(v,e,!1)?[0,0]:[0,t];default:return[0,f.length-1]}},s.prototype.by=function(a,b){var c;if(void 0===b)return c=this,function(b){return c.by(a,b)};var d=this.constraints.unique[a].get(b);return this.cloneObjects?h(d,this.cloneMethod):d},s.prototype.findOne=function(a){a=a||{};var b=new q(this,{queryObj:a,firstOnly:!0});return Array.isArray(b)&&0===b.length?null:this.cloneObjects?h(b,this.cloneMethod):b},s.prototype.chain=function(a,b){var c=new q(this);return"undefined"==typeof a?c:c.transform(a,b)},s.prototype.find=function(a){"undefined"==typeof a&&(a="getAll");var b=new q(this,{queryObj:a});return this.cloneObjects?i(b,this.cloneMethod):b},s.prototype.findOneUnindexed=function(a,b){for(var c,d=this.data.length;d--;)if(this.data[d][a]===b)return c=this.data[d];return null},s.prototype.startTransaction=function(){if(this.transactional){this.cachedData=h(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices;for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].startTransaction()}},s.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null;for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].commit()}},s.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex);for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].rollback()}},s.prototype.async=function(a,b){setTimeout(function(){if("function"!=typeof a)throw new TypeError("Argument passed for async execution is not a function");a(),b()},0)},s.prototype.where=function(a){var b=new q(this,{queryFunc:a});return this.cloneObjects?i(b,this.cloneMethod):b},s.prototype.mapReduce=function(a,b){try{return b(this.data.map(a))}catch(c){throw c}},s.prototype.eqJoin=function(a,b,c,d){return new q(this).eqJoin(a,b,c,d)},s.prototype.stages={},s.prototype.getStage=function(a){return this.stages[a]||(this.stages[a]={}),this.stages[a]},s.prototype.commitLog=[],s.prototype.stage=function(a,b){var c=JSON.parse(JSON.stringify(b));return this.getStage(a)[b.$loki]=c,c},s.prototype.commitStage=function(a,b){var c,d=this.getStage(a),e=(new Date).getTime();for(c in d)this.update(d[c]),this.commitLog.push({timestamp:e,message:b,data:JSON.parse(JSON.stringify(d[c]))});this.stages[a]={}},s.prototype.no_op=function(){},s.prototype.extract=function(a){var b=0,c=this.data.length,d=t(a),e=[];for(b;c>b;b+=1)e.push(z(this.data[b],a,d));return e},s.prototype.max=function(a){return Math.max.apply(null,this.extract(a))},s.prototype.min=function(a){return Math.min.apply(null,this.extract(a))},s.prototype.maxRecord=function(a){var b,c=0,d=this.data.length,e=t(a),f={index:0,value:void 0};for(c;d>c;c+=1)void 0!==b?b<z(this.data[c],a,e)&&(b=z(this.data[c],a,e),f.index=this.data[c].$loki):(b=z(this.data[c],a,e),f.index=this.data[c].$loki);return f.value=b,f},s.prototype.minRecord=function(a){var b,c=0,d=this.data.length,e=t(a),f={index:0,value:void 0};for(c;d>c;c+=1)void 0!==b?b>z(this.data[c],a,e)&&(b=z(this.data[c],a,e),f.index=this.data[c].$loki):(b=z(this.data[c],a,e),f.index=this.data[c].$loki);return f.value=b,f},s.prototype.extractNumerical=function(a){return this.extract(a).map(u).filter(Number).filter(function(a){return!isNaN(a)})},s.prototype.avg=function(a){return x(this.extractNumerical(a))},s.prototype.stdDev=function(a){return y(this.extractNumerical(a))},s.prototype.mode=function(a){var b={},c=this.extract(a);c.forEach(function(a){b[a]?b[a]+=1:b[a]=1});var d,e,f;for(e in b)d?d<b[e]&&(f=e):(f=e,d=b[e]);return f},s.prototype.median=function(a){var b=this.extractNumerical(a);b.sort(w);var c=Math.floor(b.length/2);return b.length%2?b[c]:(b[c-1]+b[c])/2},C.prototype={keys:[],values:[],sort:function(a,b){return b>a?-1:a>b?1:0},setSort:function(a){this.bs=new B(a)},bs:function(){return new B(this.sort)},set:function(a,b){var c=this.bs(this.keys,a);c.found?this.values[c.index]=b:(this.keys.splice(c.index,0,a),this.values.splice(c.index,0,b))},get:function(a){return this.values[A(this.keys,a,this.sort).index]}},D.prototype.keyMap={},D.prototype.lokiMap={},D.prototype.set=function(a){var b=a[this.field];if(null!==b&&"undefined"!=typeof b){if(this.keyMap[b])throw new Error("Duplicate key for property "+this.field+": "+b);this.keyMap[b]=a,this.lokiMap[a.$loki]=b}},D.prototype.get=function(a){return this.keyMap[a]},D.prototype.byId=function(a){return this.keyMap[this.lokiMap[a]]},D.prototype.update=function(a,b){if(this.lokiMap[a.$loki]!==b[this.field]){var c=this.lokiMap[a.$loki];this.set(b),this.keyMap[c]=void 0}else this.keyMap[a[this.field]]=b},D.prototype.remove=function(a){var b=this.keyMap[a];if(null===b||"undefined"==typeof b)throw new Error("Key is not in unique index: "+this.field);this.keyMap[a]=void 0,this.lokiMap[b.$loki]=void 0},D.prototype.clear=function(){this.keyMap={},this.lokiMap={}},E.prototype={set:function(a,b){this.index[a]?this.index[a].push(b):this.index[a]=[b]},remove:function(a,b){var c=this.index[a];for(var d in c)c[d]==b&&c.splice(d,1);c.length<1&&(this.index[a]=void 0)},get:function(a){return this.index[a]},clear:function(){this.index={}}},F.prototype={keys:[],values:[],sort:function(a,b){return b>a?-1:a>b?1:0},bs:function(){return new B(this.sort)},setSort:function(a){this.bs=new B(a)},set:function(a,b){var c=A(this.keys,a,this.sort);c.found?this.values[c.index].push(b):(this.keys.splice(c.index,0,a),this.values.splice(c.index,0,[b]))},get:function(a){var b=A(this.keys,a,this.sort);return b.found?this.values[b.index]:[]},getLt:function(a){var b=A(this.keys,a,this.sort),c=b.index;return b.found&&c--,this.getAll(a,0,c)},getGt:function(a){var b=A(this.keys,a,this.sort),c=b.index;return b.found&&c++,this.getAll(a,c,this.keys.length)},getAll:function(a,b,c){for(var d=[],e=b;c>e;e++)d=d.concat(this.values[e]);return d},getPos:function(a){return A(this.keys,a,this.sort)},remove:function(a,b){var c=A(this.keys,a,this.sort).index,d=this.values[c];for(var e in d)d[e]==b&&d.splice(e,1);d.length<1&&(this.keys.splice(c,1),this.values.splice(c,1))},clear:function(){this.keys=[],this.values=[]}},l.LokiOps=I,l.Collection=s,l.KeyValueStore=C,l.LokiMemoryAdapter=m,l.LokiPartitioningAdapter=n,l.LokiLocalStorageAdapter=p,l.LokiFsAdapter=o,l.persistenceAdapters={fs:o,localStorage:p},l}()});